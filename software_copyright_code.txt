// --- START OF FILE: package.json ---
{
  "name": "wordsmith-ai",
  "private": true,
  "version": "0.0.0",
  "description": "WordSmith AIï¼ˆæ™ºæ’ç²¾çµï¼‰- AI é©±åŠ¨çš„ Word é«˜ä¿çœŸæ’ç‰ˆæ¡Œé¢åº”ç”¨",
  "author": "WordSmith AI",
  "type": "module",
  "scripts": {
    "dev": "npm run cleanup && vite",
    "start": "npm run dev",
    "cleanup": "cmd /c \"taskkill /F /IM electron.exe /T >NUL 2>&1 & exit /b 0\"",
    "build": "tsc && vite build && electron-builder",
    "lint": "eslint . --ext ts,tsx --report-unused-disable-directives --max-warnings 0",
    "preview": "vite preview",
    "test": "vitest run -c vitest.config.ts",
    "test:watch": "vitest -c vitest.config.ts"
  },
  "dependencies": {
    "@monaco-editor/react": "^4.7.0",
    "lucide-react": "^0.563.0",
    "monaco-editor": "^0.55.1",
    "prismjs": "^1.30.0",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-router-dom": "^7.13.0",
    "zustand": "^5.0.10"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4.1.18",
    "@types/prismjs": "^1.26.5",
    "@types/react": "^18.2.64",
    "@types/react-dom": "^18.2.21",
    "@typescript-eslint/eslint-plugin": "^7.1.1",
    "@typescript-eslint/parser": "^7.1.1",
    "@vitejs/plugin-react": "^4.2.1",
    "autoprefixer": "^10.4.23",
    "electron": "^30.0.1",
    "electron-builder": "^24.13.3",
    "eslint": "^8.57.0",
    "eslint-plugin-react-hooks": "^4.6.0",
    "eslint-plugin-react-refresh": "^0.4.5",
    "jsdom": "^27.4.0",
    "postcss": "^8.5.6",
    "tailwindcss": "^4.1.18",
    "typescript": "~5.5.4",
    "vite": "^5.1.6",
    "vite-plugin-electron": "^0.28.6",
    "vite-plugin-electron-renderer": "^0.14.5",
    "vitest": "^4.0.18"
  },
  "main": "dist-electron/index.js"
}


// --- START OF FILE: electron-builder.json5 ---
// @see - https://www.electron.build/configuration/configuration
{
  "$schema": "https://raw.githubusercontent.com/electron-userland/electron-builder/master/packages/app-builder-lib/scheme.json",
  "appId": "com.wordsmith.ai",
  "asar": true,
  "productName": "WordSmith AI",
  "directories": {
    "output": "release/${version}"
  },
  "files": [
    "dist",
    "dist-electron"
  ],
  "mac": {
    "target": [
      "dmg"
    ],
    "artifactName": "${productName}-Mac-${version}-Installer.${ext}"
  },
  "win": {
    "target": [
      {
        "target": "nsis",
        "arch": [
          "x64"
        ]
      }
    ],
    "artifactName": "${productName}-Windows-${version}-Setup.${ext}"
  },
  "nsis": {
    "oneClick": false,
    "perMachine": false,
    "allowToChangeInstallationDirectory": true,
    "deleteAppDataOnUninstall": false
  },
  "linux": {
    "target": [
      "AppImage"
    ],
    "artifactName": "${productName}-Linux-${version}.${ext}"
  }
}


// --- START OF FILE: vite.config.ts ---
import { defineConfig } from 'vite'
import path from 'node:path'
import electron from 'vite-plugin-electron/simple'
import react from '@vitejs/plugin-react'

// https://vitejs.dev/config/
export default defineConfig({
  base: './',
  server: {
    host: '127.0.0.1',
    port: 5173,
  },
  plugins: [
    react(),
    electron({
      main: {
        // Shortcut of `build.lib.entry`.
        entry: 'src/main/index.ts',
      },
      preload: {
        // Shortcut of `build.rollupOptions.input`.
        // Preload scripts may contain Web assets, so use the `build.rollupOptions.input` instead `build.lib.entry`.
        input: path.join(__dirname, 'src/main/preload.ts'),
        vite: {
          build: {
            rollupOptions: {
              output: {
                format: 'cjs',
                entryFileNames: 'preload.cjs',
              },
            },
          },
        },
      },
      // Ployfill the Electron and Node.js API for Renderer process.
      // If you want use Node.js in Renderer process, the `nodeIntegration` needs to be enabled in the Main process.
      // See ğŸ‘‰ https://github.com/electron-vite/vite-plugin-electron-renderer
      renderer: process.env.NODE_ENV === 'test'
        // https://github.com/electron-vite/vite-plugin-electron-renderer/issues/78#issuecomment-2053600808
        ? undefined
        : {},
    }),
  ],
})


// --- START OF FILE: tsconfig.json ---
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true
  },
  "include": ["src"],
  "references": [{ "path": "./tsconfig.node.json" }]
}


// --- START OF FILE: src/main/electron-env.d.ts ---
/// <reference types="vite-plugin-electron/electron-env" />

declare namespace NodeJS {
  interface ProcessEnv {
    /**
     * The built directory structure
     *
     * ```tree
     * â”œâ”€â”¬â”€â”¬ dist
     * â”‚ â”‚ â””â”€â”€ index.html
     * â”‚ â”‚
     * â”‚ â”œâ”€â”¬ dist-electron
     * â”‚ â”‚ â”œâ”€â”€ main.js
     * â”‚ â”‚ â””â”€â”€ preload.js
     * â”‚
     * ```
     */
    APP_ROOT: string
    /** /dist/ or /public/ */
    VITE_PUBLIC: string
  }
}

// Used in Renderer process, expose in `preload.ts`
interface Window {
  wordsmith?: {
    clipboard: {
      write: (payload: { html: string; text: string }) => Promise<void>
    }
  }
}


// --- START OF FILE: src/main/index.ts ---
import { app, BrowserWindow, clipboard, ipcMain } from 'electron'
import { fileURLToPath } from 'node:url'
import path from 'node:path'

const __dirname = path.dirname(fileURLToPath(import.meta.url))

// The built directory structure
//
// â”œâ”€â”¬â”€â”¬ dist
// â”‚ â”‚ â””â”€â”€ index.html
// â”‚ â”‚
// â”‚ â”œâ”€â”¬ dist-electron
// â”‚ â”‚ â”œâ”€â”€ main.js
// â”‚ â”‚ â””â”€â”€ preload.mjs
// â”‚
process.env.APP_ROOT = path.join(__dirname, '..')

// ğŸš§ Use ['ENV_NAME'] avoid vite:define plugin - Vite@2.x
export const VITE_DEV_SERVER_URL = process.env['VITE_DEV_SERVER_URL']
export const MAIN_DIST = path.join(process.env.APP_ROOT, 'dist-electron')
export const RENDERER_DIST = path.join(process.env.APP_ROOT, 'dist')

process.env.VITE_PUBLIC = VITE_DEV_SERVER_URL ? path.join(process.env.APP_ROOT, 'public') : RENDERER_DIST

let win: BrowserWindow | null

function normalizeDevServerUrl(url: string): string {
  try {
    const u = new URL(url)
    if (u.hostname === 'localhost') u.hostname = '127.0.0.1'
    return u.toString()
  } catch {
    return url
  }
}

async function loadUrlWithRetry(win: BrowserWindow, url: string, retries = 20, delay = 1000) {
  let attempt = 0
  while (attempt < retries) {
    try {
      const normalized = normalizeDevServerUrl(url)
      console.log(`[Main] Attempting to load URL: ${normalized} (Attempt ${attempt + 1}/${retries})`)
      await win.loadURL(normalized)
      console.log(`[Main] Successfully loaded URL: ${normalized}`)
      return
    } catch (error) {
      const err = error as Error
      console.error(`[Main] Failed to load URL: ${url}. Error: ${err.message}`)
      attempt++
      if (attempt < retries) {
        console.log(`[Main] Retrying in ${delay}ms...`)
        await new Promise((resolve) => setTimeout(resolve, delay))
      }
    }
  }
  console.error(`[Main] Failed to load URL after ${retries} attempts.`)
  // Fallback to local file if remote load fails completely
  try {
    console.log('[Main] Falling back to local file...')
    await win.loadFile(path.join(RENDERER_DIST, 'index.html'))
  } catch (e) {
    console.error('[Main] Failed to fallback to local file.', e)
  }
}

ipcMain.handle('clipboard:write', async (_event, payload: { html: string; text: string }) => {
  clipboard.write({
    html: payload.html,
    text: payload.text,
  })
})

async function createWindow() {
  win = new BrowserWindow({
    icon: path.join(process.env.VITE_PUBLIC, 'electron-vite.svg'),
    webPreferences: {
      preload: path.join(__dirname, 'preload.cjs'),
      contextIsolation: true,
      nodeIntegration: false,
      sandbox: false,
    },
  })

  // Test active push message to Renderer-process.
  win.webContents.on('did-finish-load', () => {
    win?.webContents.send('main-process-message', (new Date).toLocaleString())
  })

  if (VITE_DEV_SERVER_URL) {
    await loadUrlWithRetry(win, VITE_DEV_SERVER_URL)
  } else {
    await win.loadFile(path.join(RENDERER_DIST, 'index.html'))
  }
}

// Quit when all windows are closed, except on macOS. There, it's common
// for applications and their menu bar to stay active until the user quits
// explicitly with Cmd + Q.
app.on('window-all-closed', () => {
  if (process.platform !== 'darwin') {
    app.quit()
    win = null
  }
})

app.on('activate', () => {
  // On OS X it's common to re-create a window in the app when the
  // dock icon is clicked and there are no other windows open.
  if (BrowserWindow.getAllWindows().length === 0) {
    createWindow()
  }
})

app.whenReady().then(createWindow)

process.on('unhandledRejection', (err) => {
  // Avoid noisy crash in dev if dev server has not started yet
  console.error('[unhandledRejection]', err)
})


// --- START OF FILE: src/main/preload.ts ---
import { ipcRenderer, contextBridge } from 'electron'

contextBridge.exposeInMainWorld('wordsmith', {
  clipboard: {
    write(payload: { html: string; text: string }) {
      return ipcRenderer.invoke('clipboard:write', payload)
    },
  },
})


// --- START OF FILE: src/renderer/App.css ---
#root {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms;
}
.logo:hover {
  filter: drop-shadow(0 0 2em #646cffaa);
}
.logo.react:hover {
  filter: drop-shadow(0 0 2em #61dafbaa);
}

@keyframes logo-spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@media (prefers-reduced-motion: no-preference) {
  a:nth-of-type(2) .logo {
    animation: logo-spin infinite 20s linear;
  }
}

.card {
  padding: 2em;
}

.read-the-docs {
  color: #888;
}


// --- START OF FILE: src/renderer/App.tsx ---
import { Route, Routes } from 'react-router-dom'
import { useAppStore } from './store/useAppStore'
import { useEffect } from 'react'
import NewPage from './pages/New'
import HistoryPage from './pages/History'
import SettingsPage from './pages/Settings'
import TemplatesPage from './pages/Templates'
import HelpPage from './pages/Help'
import { OnboardingModal } from './components/business/OnboardingModal'

function App() {
  const theme = useAppStore((s) => s.settings.theme)
  const eyeCareMode = useAppStore((s) => s.settings.eyeCareMode)

  useEffect(() => {
    const root = window.document.documentElement
    root.classList.remove('light', 'dark', 'eye-care')

    // Handle Theme
    if (theme === 'system') {
      const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
      root.classList.add(systemTheme)
    } else {
      root.classList.add(theme)
    }

    // Handle Eye Care Mode (only effective in light mode ideally, but we apply class anyway)
    // We check if current resolved theme is light to apply eye-care fully effectively
    if (eyeCareMode) {
      root.classList.add('eye-care')
    }
  }, [theme, eyeCareMode])

  return (
    <div className="h-full w-full overflow-hidden">
      <OnboardingModal />
      <Routes>
        <Route path="/" element={<NewPage />} />
        <Route path="/history" element={<HistoryPage />} />
        <Route path="/templates" element={<TemplatesPage />} />
        <Route path="/settings" element={<SettingsPage />} />
        <Route path="/help" element={<HelpPage />} />
      </Routes>
    </div>
  )
}

export default App


// --- START OF FILE: src/renderer/components/business/ChatPanel.tsx ---
import { useMemo, useRef, useState } from 'react'
import { Send, Square } from 'lucide-react'
import type { ChatMessage, PromptMode } from '../../types/ai'
import type { GuardReport } from '../../types/guard'
import { guardHtml } from '../../lib/protocol-guard'
import { streamChat } from '../../services/ai-service'
import { errorHandler } from '../../services/ErrorHandler'
import { logger } from '../../services/LoggerService'
import { useI18n } from '../../store/useI18nStore'
import { Button } from '../ui/button'
import { CardHeader, CardTitle } from '../ui/card'
import { Input } from '../ui/input'
import { Textarea } from '../ui/textarea'

export interface ChatPanelProps {
  baseUrl: string
  apiKey: string
  model: string
  defaults: { fontFamily: string; fontSizePt: number }
  presetPrompt?: string
  htmlDraft: string
  onHtmlFinalized: (html: string, report: GuardReport, payload: { mode: PromptMode; messages: ChatMessage[] }) => void
}

export function ChatPanel({ baseUrl, apiKey, model, defaults, presetPrompt, htmlDraft, onHtmlFinalized }: ChatPanelProps) {
  const t = useI18n()
  const [mode, setMode] = useState<PromptMode>('generate')
  const [input, setInput] = useState('')
  const [messages, setMessages] = useState<Array<ChatMessage>>([])
  const [streaming, setStreaming] = useState(false)
  const abortRef = useRef<AbortController | null>(null)

  const canSend = useMemo(() => {
    if (streaming) return false
    if (!baseUrl || !model) return false
    if (mode === 'generate') return input.trim().length > 0
    return htmlDraft.trim().length > 0
  }, [baseUrl, model, mode, input, htmlDraft, streaming])

  const stop = () => {
    abortRef.current?.abort()
    abortRef.current = null
  }

  const send = async () => {
    const controller = new AbortController()
    abortRef.current = controller
    setStreaming(true)

    const userText = mode === 'generate' ? input.trim() : htmlDraft.trim()
    const seed: ChatMessage[] = messages.length === 0 && presetPrompt ? [{ role: 'system', content: presetPrompt }] : []
    const nextMessages: ChatMessage[] = [
      ...seed,
      ...messages,
      { role: 'user', content: userText },
      { role: 'assistant', content: '' },
    ]
    setMessages(nextMessages)

    logger.action('ChatPanel', 'Start generation', { mode, model })

    try {
      let assistantText = ''
      const stream = streamChat({
        mode,
        model: { baseUrl, apiKey, model },
        defaults,
        messages: nextMessages.slice(0, -1),
        signal: controller.signal,
      })

      // Use error handler wrapper but we need to iterate manually for streaming
      for await (const delta of stream) {
        assistantText += delta
        setMessages((prev) => {
          const cloned = prev.slice()
          const last = cloned[cloned.length - 1]
          if (!last || last.role !== 'assistant') return prev
          cloned[cloned.length - 1] = { ...last, content: assistantText }
          return cloned
        })
      }

      const guarded = guardHtml(assistantText, defaults)
      const finishedMessages: ChatMessage[] = [...nextMessages.slice(0, -1), { role: 'assistant', content: assistantText }]
      onHtmlFinalized(guarded.html, guarded.report, { mode, messages: finishedMessages })
      setInput('')
      logger.info('ChatPanel', 'Generation success', { length: assistantText.length })
    } catch (e) {
      if (e instanceof Error && e.name === 'AbortError') {
        logger.info('ChatPanel', 'Generation aborted')
      } else {
        errorHandler.handle(e, 'api')
      }
    } finally {
      setStreaming(false)
      abortRef.current = null
    }
  }

  return (
    <div className="flex h-full flex-col">
      <div className="shrink-0 pb-3">
        <CardHeader className="p-0">
          <div className="flex items-center justify-between gap-3">
            <CardTitle>{t.chat.title}</CardTitle>
            <div className="flex items-center gap-2">
              <Button
                size="sm"
                variant={mode === 'generate' ? 'default' : 'secondary'}
                onClick={() => setMode('generate')}
                disabled={streaming}
              >
                {t.chat.generate}
              </Button>
              <Button size="sm" variant={mode === 'fix' ? 'default' : 'secondary'} onClick={() => setMode('fix')} disabled={streaming}>
                {t.chat.fix}
              </Button>
            </div>
          </div>
        </CardHeader>
      </div>
      
      <div className="flex min-h-0 flex-1 flex-col gap-3">
        <div className="flex-1 overflow-y-auto rounded-lg border border-slate-200 bg-slate-50 p-3 dark:border-slate-800 dark:bg-slate-900">
          <div className="space-y-3">
            {messages.length === 0 ? (
              <div className="text-xs text-slate-500 dark:text-slate-400">{t.chat.emptyTip}</div>
            ) : null}
            {messages
              .filter((m) => m.role === 'user' || m.role === 'assistant')
              .map((m, idx) => {
                const isUser = m.role === 'user'
                return (
                  <div key={idx} className={isUser ? 'flex justify-end' : 'flex justify-start'}>
                    <div
                      className={
                        isUser
                          ? 'max-w-[90%] rounded-xl bg-slate-900 px-3 py-2 text-xs text-white dark:bg-slate-100 dark:text-slate-900'
                          : 'max-w-[90%] rounded-xl bg-white px-3 py-2 text-xs text-slate-800 dark:bg-slate-950 dark:text-slate-100'
                      }
                    >
                      <pre className="whitespace-pre-wrap font-sans">{m.content}</pre>
                    </div>
                  </div>
                )
              })}
          </div>
        </div>

        <div className="flex shrink-0 items-end gap-2 pb-1">
          {mode === 'generate' ? (
            <Textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t.chat.placeholder}
              disabled={streaming}
              className="max-h-[120px] min-h-[40px]"
            />
          ) : (
            <Input value={t.chat.placeholderFix} readOnly />
          )}

          {streaming ? (
            <Button variant="destructive" onClick={stop} className="shrink-0">
              <Square size={16} />
            </Button>
          ) : (
            <Button onClick={send} disabled={!canSend || !apiKey} className="shrink-0">
              <Send size={16} />
            </Button>
          )}
        </div>

        {!apiKey ? <div className="text-xs text-slate-500 dark:text-slate-400">{t.chat.noApiKey}</div> : null}
      </div>
    </div>
  )
}


// --- START OF FILE: src/renderer/components/business/CopyToWordButton.tsx ---
import { useState } from 'react'
import { AlertTriangle } from 'lucide-react'
import { Button } from '../ui/button'
import { useI18n } from '../../store/useI18nStore'
import { errorHandler } from '../../services/ErrorHandler'
import { logger } from '../../services/LoggerService'
import { toast } from '../../store/useToastStore'

export interface CopyToWordButtonProps {
  html: string
}

export function CopyToWordButton({ html }: CopyToWordButtonProps) {
  const t = useI18n()
  const [busy, setBusy] = useState(false)

  const copy = async () => {
    setBusy(true)
    try {
      const text = html.replace(/<[^>]+>/g, '')
      logger.action('CopyToWord', 'Write to clipboard', { length: html.length })
      
      if (window.wordsmith?.clipboard?.write) {
        await window.wordsmith.clipboard.write({ html, text })
      } else if (navigator.clipboard?.write) {
        const item = new ClipboardItem({
          'text/html': new Blob([html], { type: 'text/html' }),
          'text/plain': new Blob([text], { type: 'text/plain' }),
        })
        await navigator.clipboard.write([item])
      } else {
        await navigator.clipboard.writeText(text)
      }
      logger.info('CopyToWord', 'Success')
      toast({ 
        title: 'å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 
        description: 'âš ï¸ é‡è¦ï¼šè¯·åœ¨ Word ä¸­é€‰æ‹©ã€ä¿ç•™åŸæ ¼å¼ã€‘ç²˜è´´ï¼',
        variant: 'success',
        duration: 8000
      })
    } catch (e) {
      errorHandler.handle(e, 'system', t.errors.clipboard)
    } finally {
      setBusy(false)
    }
  }

  return (
    <div className="space-y-2">
      <Button size="lg" className="w-full" onClick={copy} disabled={busy}>
        {t.preview.copyToWord}
      </Button>
      <div className="flex items-center justify-center gap-1.5 rounded bg-amber-50 p-2 text-xs font-medium text-amber-700 dark:bg-amber-950/30 dark:text-amber-400">
        <AlertTriangle size={14} />
        <span>ç²˜è´´æ—¶åŠ¡å¿…é€‰æ‹©ã€ä¿ç•™åŸæ ¼å¼ã€</span>
      </div>
    </div>
  )
}


// --- START OF FILE: src/renderer/components/business/HtmlEditor.tsx ---
import Editor from '@monaco-editor/react'
import { CardHeader, CardTitle } from '../ui/card'
import { useI18n } from '../../store/useI18nStore'

export interface HtmlEditorProps {
  value: string
  onChange: (next: string) => void
}

export function HtmlEditor({ value, onChange }: HtmlEditorProps) {
  const t = useI18n()
  return (
    <div className="flex h-full flex-col">
      <div className="shrink-0 pb-3">
        <CardHeader className="p-0">
          <CardTitle>{t.editor.title}</CardTitle>
        </CardHeader>
      </div>
      <div className="min-h-0 flex-1 overflow-hidden rounded-lg border border-slate-200 dark:border-slate-800">
        <Editor
          height="100%"
          defaultLanguage="html"
          value={value}
          onChange={(v) => onChange(v ?? '')}
          options={{
            minimap: { enabled: false },
            wordWrap: 'on',
            fontSize: 12,
            tabSize: 2,
            automaticLayout: true,
            scrollBeyondLastLine: false,
          }}
        />
      </div>
    </div>
  )
}



// --- START OF FILE: src/renderer/components/business/MacroGenerator.tsx ---
import { useEffect, useMemo, useState } from 'react'
import Prism from 'prismjs'
import { Button } from '../ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '../ui/card'
import { useI18n } from '../../store/useI18nStore'
import { errorHandler } from '../../services/ErrorHandler'

const VBA_CODE = `Sub LatexToWordMath_Robust_Final()
    Dim rng As Range
    Dim mathRng As Range
    Dim rawContent As String
    
    Application.ScreenUpdating = False
    
    ' --- ç¬¬ä¸€é˜¶æ®µï¼šå¤„ç†è¡Œé—´å…¬å¼ $$...$$ ---
    Set rng = ActiveDocument.Content
    With rng.Find
        .ClearFormatting
        .Text = "\\$\\$*\\$\\$"
        .MatchWildcards = True
        Do While .Execute
            ' åˆ›å»ºå‰¯æœ¬åŒºåŸŸè¿›è¡Œç²¾å‡†åˆ‡å‰²ï¼Œä¿ç•™è®ºå›åŸå§‹çš„ç¨³å¥é€»è¾‘
            Set mathRng = rng.Duplicate
            mathRng.MoveEnd Unit:=wdCharacter, Count:=-2
            mathRng.Start = mathRng.Start + 2
            
            rawContent = mathRng.Text
            rng.Text = rawContent ' å°† $$ å†…å®¹æ›¿æ¢ä¸ºçº¯æ–‡æœ¬
            
            ' å…³é”®åŠ¨ä½œï¼šæ·»åŠ å…¬å¼å¯¹è±¡å¹¶å¼ºåˆ¶â€œç”±çº¿æ€§è½¬ä¸ºä¸“ä¸šæ ¼å¼â€
            ActiveDocument.OMaths.Add rng
            rng.OMaths(1).BuildUp ' å¼ºåˆ¶æ¸²æŸ“æˆåˆ†æ•°çº¿ã€æ ¹å·ç­‰ä¸“ä¸šæ ·å¼
            
            rng.Collapse wdCollapseEnd
        Loop
    End With
    
    ' --- ç¬¬äºŒé˜¶æ®µï¼šå¤„ç†è¡Œå†…å…¬å¼ $...$ ---
    Set rng = ActiveDocument.Content
    With rng.Find
        .ClearFormatting
        .Text = "\\$*\\$"
        .MatchWildcards = True
        Do While .Execute
            ' å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿ä¸æ˜¯åˆšåˆšå¤„ç†è¿‡çš„å…¬å¼
            If rng.OMaths.Count = 0 Then
                Set mathRng = rng.Duplicate
                mathRng.MoveEnd Unit:=wdCharacter, Count:=-1
                mathRng.Start = mathRng.Start + 1
                
                rawContent = mathRng.Text
                rng.Text = rawContent
                
                ActiveDocument.OMaths.Add rng
                ' å†æ¬¡å¼ºåˆ¶è§¦å‘ä¸“ä¸šæ’ç‰ˆæ¸²æŸ“
                rng.OMaths(1).BuildUp
            End If
            rng.Collapse wdCollapseEnd
        Loop
    End With
    
    Application.ScreenUpdating = True
    MsgBox "å…¨æ–‡æ¡£å…¬å¼åŠæ’ç‰ˆå·²æ·±åº¦è½¬æ¢å®Œæˆï¼"
End Sub`

export function MacroGenerator() {
  const t = useI18n()
  const [ready, setReady] = useState(false)

  useEffect(() => {
    ;(globalThis as any).Prism = Prism
    import('prismjs/components/prism-vbnet')
      .catch(() => undefined)
      .finally(() => setReady(true))
  }, [])

  const highlighted = useMemo(() => {
    const language = Prism.languages.vbnet ?? Prism.languages.plain
    return Prism.highlight(VBA_CODE, language, language === Prism.languages.vbnet ? 'vbnet' : 'plain')
  }, [ready])

  const copy = async () => {
    try {
      await navigator.clipboard.writeText(VBA_CODE)
    } catch (e) {
      errorHandler.handle(e, 'system', t.errors.clipboard)
    }
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle>{t.macro.title}</CardTitle>
        <Button variant="secondary" size="sm" onClick={copy}>
          {t.macro.copy}
        </Button>
      </CardHeader>
      <CardContent>
        <div className="space-y-3">
          <p className="text-xs text-slate-600 dark:text-slate-400">
            {t.macro.desc}
          </p>
          <pre className="max-h-[240px] overflow-auto rounded-lg bg-slate-950 p-3 text-xs text-slate-100">
            <code dangerouslySetInnerHTML={{ __html: highlighted }} />
          </pre>
          <ol className="list-decimal space-y-1 pl-4 text-xs text-slate-600 dark:text-slate-400">
            <li>{t.macro.step1}</li>
            <li>{t.macro.step2}</li>
            <li>{t.macro.step3}</li>
          </ol>
        </div>
      </CardContent>
    </Card>
  )
}


// --- START OF FILE: src/renderer/components/business/OnboardingModal.tsx ---
import { useState, useEffect } from 'react'
import { Rocket, AlertTriangle, CheckCircle2 } from 'lucide-react'
import { useAppStore } from '../../store/useAppStore'
import { Button } from '../ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '../ui/card'
import { Input } from '../ui/input'
import { cn } from '../../lib/cn'

export function OnboardingModal() {
  const [open, setOpen] = useState(false)
  const [step, setStep] = useState(1)
  const settings = useAppStore((s) => s.settings)
  const updateAi = useAppStore((s) => s.updateAi)

  useEffect(() => {
    const hasOnboarded = localStorage.getItem('wordsmith-onboarded')
    if (!hasOnboarded) {
      setOpen(true)
    }
  }, [])

  const handleComplete = () => {
    localStorage.setItem('wordsmith-onboarded', 'true')
    setOpen(false)
  }

  if (!open) return null

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
      <Card className="w-full max-w-lg shadow-2xl animate-in fade-in zoom-in-95 duration-300">
        <CardHeader>
          <div className="flex items-center gap-2 text-blue-600 dark:text-blue-400">
            <Rocket className="h-6 w-6" />
            <span className="text-sm font-bold uppercase tracking-wider">æ¬¢è¿ä½¿ç”¨ WordSmith AI</span>
          </div>
          <CardTitle className="text-2xl">
            {step === 1 && 'å¼€å¯æ™ºèƒ½æ’ç‰ˆä¹‹æ—…'}
            {step === 2 && 'è¿æ¥ AI å¤§è„‘'}
            {step === 3 && 'æ ¸å¿ƒæ“ä½œè¦é¢†'}
            {step === 4 && 'å‡†å¤‡å°±ç»ªï¼'}
          </CardTitle>
        </CardHeader>
        
        <CardContent className="space-y-6">
          {/* Step 1: Welcome */}
          {step === 1 && (
            <div className="space-y-4">
              <p className="text-slate-600 dark:text-slate-300">
                WordSmith AI æ˜¯ä¸€æ¬¾ä¸“ä¸ºä¸“ä¸šæ–‡æ¡£è®¾è®¡çš„æ’ç‰ˆå·¥å…·ã€‚å®ƒèƒ½å°† AI ç”Ÿæˆçš„å†…å®¹è½¬æ¢ä¸ºç¬¦åˆ <strong>Word æ’ç‰ˆåè®®</strong> çš„æ ¼å¼ï¼Œå®Œç¾ä¿ç•™å…¬å¼ã€è¡¨æ ¼å’Œæ ·å¼ã€‚
              </p>
              <div className="rounded-lg bg-slate-50 p-4 dark:bg-slate-900">
                <ul className="list-disc pl-4 space-y-2 text-sm text-slate-700 dark:text-slate-300">
                  <li>æ”¯æŒæ‰€æœ‰ OpenAI å…¼å®¹æ¥å£ (DeepSeek, Kimi, etc.)</li>
                  <li>ç‹¬å®¶ Inline CSS å®ˆå«æŠ€æœ¯</li>
                  <li>å®Œç¾æ¸²æŸ“ LaTeX æ•°å­¦å…¬å¼</li>
                </ul>
              </div>
            </div>
          )}

          {/* Step 2: Configuration */}
          {step === 2 && (
            <div className="space-y-4">
              <p className="text-sm text-slate-600 dark:text-slate-400">
                è¯·å…ˆé…ç½®æ‚¨çš„ AI æœåŠ¡å•†ã€‚ä¸ç”¨æ‹…å¿ƒï¼Œç¨åå¯ä»¥åœ¨ã€è®¾ç½®ã€‘ä¸­éšæ—¶ä¿®æ”¹ã€‚
              </p>
              <div className="space-y-3">
                <div className="space-y-1">
                  <label className="text-xs font-medium">API æä¾›å•†</label>
                  <select
                    className="flex h-10 w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 dark:border-slate-800 dark:bg-slate-950"
                    onChange={(e) => updateAi({ baseUrl: e.target.value })}
                    value={settings.ai.baseUrl}
                  >
                    <option value="https://api.deepseek.com">DeepSeek</option>
                    <option value="https://api.moonshot.cn">Moonshot (æœˆä¹‹æš—é¢)</option>
                    <option value="https://api.siliconflow.cn">SiliconFlow (ç¡…åŸºæµåŠ¨)</option>
                    <option value="custom">Custom (è‡ªå®šä¹‰)</option>
                  </select>
                </div>
                <div className="space-y-1">
                  <label className="text-xs font-medium">API Key</label>
                  <Input
                    value={settings.ai.apiKey}
                    onChange={(e) => updateAi({ apiKey: e.target.value })}
                    placeholder="sk-..."
                    type="password"
                  />
                </div>
              </div>
            </div>
          )}

          {/* Step 3: Paste Warning */}
          {step === 3 && (
            <div className="space-y-6 text-center">
              <div className="mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-amber-100 text-amber-600 dark:bg-amber-900/30 dark:text-amber-400">
                <AlertTriangle size={32} />
              </div>
              <div className="space-y-2">
                <h3 className="text-lg font-bold text-amber-700 dark:text-amber-400">è‡³å…³é‡è¦çš„ä¸€æ­¥</h3>
                <p className="text-sm text-slate-600 dark:text-slate-300">
                  ä¸ºäº†ç¡®ä¿æ ·å¼ä¸ä¸¢å¤±ï¼Œåœ¨ Word ä¸­ç²˜è´´å†…å®¹æ—¶ï¼Œ<br />
                  <span className="font-bold text-slate-900 underline decoration-amber-500 decoration-2 underline-offset-2 dark:text-white">
                    å¿…é¡»é€‰æ‹©â€œä¿ç•™åŸæ ¼å¼ (Keep Source Formatting)â€
                  </span>
                </p>
              </div>
              <div className="rounded-lg border-2 border-dashed border-slate-200 bg-slate-50 p-4 text-xs text-slate-500 dark:border-slate-800 dark:bg-slate-900">
                (é€šå¸¸æ˜¯ç²˜è´´é€‰é¡¹ä¸­çš„ç¬¬ä¸€ä¸ªå›¾æ ‡ ğŸ“‹)
              </div>
            </div>
          )}

          {/* Step 4: Ready */}
          {step === 4 && (
            <div className="space-y-6 text-center">
              <div className="mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400">
                <CheckCircle2 size={32} />
              </div>
              <div className="space-y-2">
                <h3 className="text-lg font-bold text-slate-900 dark:text-white">é…ç½®å®Œæˆï¼</h3>
                <p className="text-slate-600 dark:text-slate-300">
                  æ‚¨ç°åœ¨å¯ä»¥å¼€å§‹åˆ›å»ºç¬¬ä¸€ä¸ªæ’ç‰ˆä»»åŠ¡äº†ã€‚<br />
                  è®°å¾—æŸ¥çœ‹å·¦ä¾§çš„ã€å¸®åŠ©ä¸­å¿ƒã€‘è·å–æ›´å¤šæŠ€å·§ã€‚
                </p>
              </div>
            </div>
          )}

          {/* Footer Navigation */}
          <div className="flex items-center justify-between pt-4">
            <div className="flex gap-1">
              {[1, 2, 3, 4].map((i) => (
                <div
                  key={i}
                  className={cn(
                    'h-2 w-2 rounded-full transition-colors',
                    step === i ? 'bg-blue-600 dark:bg-blue-400' : 'bg-slate-200 dark:bg-slate-800'
                  )}
                />
              ))}
            </div>
            <div className="flex gap-2">
              {step > 1 && (
                <Button variant="ghost" onClick={() => setStep(step - 1)}>
                  ä¸Šä¸€æ­¥
                </Button>
              )}
              {step < 4 ? (
                <Button onClick={() => setStep(step + 1)}>ä¸‹ä¸€æ­¥</Button>
              ) : (
                <Button onClick={handleComplete} className="bg-green-600 hover:bg-green-700 dark:bg-green-600 dark:hover:bg-green-700 text-white">
                  å¼€å§‹ä½¿ç”¨
                </Button>
              )}
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  )
}


// --- START OF FILE: src/renderer/components/business/PreviewFrame.tsx ---
import { CardHeader, CardTitle } from '../ui/card'
import { useI18n } from '../../store/useI18nStore'

export interface PreviewFrameProps {
  html: string
}

export function PreviewFrame({ html }: PreviewFrameProps) {
  const t = useI18n()
  return (
    <div className="flex h-full flex-col">
      <div className="shrink-0 pb-3">
        <CardHeader className="p-0">
          <CardTitle>{t.preview.title}</CardTitle>
        </CardHeader>
      </div>
      <div className="min-h-0 flex-1">
        <iframe
          title="preview"
          className="h-full w-full rounded-lg border border-slate-200 bg-white dark:border-slate-800"
          sandbox="allow-same-origin"
          srcDoc={html}
        />
      </div>
    </div>
  )
}



// --- START OF FILE: src/renderer/components/business/Sidebar.tsx ---
import { Link, useLocation } from 'react-router-dom'
import { BookTemplate, Clock, FilePlus2, HelpCircle, Settings } from 'lucide-react'
import { cn } from '../../lib/cn'
import { useI18n } from '../../store/useI18nStore'

export function Sidebar() {
  const location = useLocation()
  const t = useI18n()

  const NAV = [
    { to: '/', label: t.nav.new, icon: FilePlus2 },
    { to: '/history', label: t.nav.history, icon: Clock },
    { to: '/templates', label: t.nav.templates, icon: BookTemplate },
    { to: '/settings', label: t.nav.settings, icon: Settings },
    { to: '/help', label: 'å¸®åŠ©ä¸­å¿ƒ', icon: HelpCircle },
  ]

  return (
    <aside className="flex h-full w-[200px] shrink-0 flex-col border-r border-slate-200 bg-white px-3 py-4 dark:border-slate-800 dark:bg-slate-950">
      <div className="px-2 pb-4">
        <div className="text-sm font-semibold text-slate-900 dark:text-slate-100">{t.common.appName}</div>
        <div className="text-xs text-slate-500 dark:text-slate-400">{t.common.appDesc.split(' - ')[0]}</div>
      </div>
      <nav className="space-y-1">
        {NAV.map((item) => {
          const active = location.pathname === item.to
          const Icon = item.icon
          return (
            <Link
              key={item.to}
              to={item.to}
              className={cn(
                'flex items-center gap-2 rounded-lg px-3 py-2 text-sm text-slate-700 hover:bg-slate-100 dark:text-slate-200 dark:hover:bg-slate-900',
                active && 'bg-slate-100 text-slate-900 dark:bg-slate-900 dark:text-white',
              )}
            >
              <Icon size={16} />
              <span>{item.label}</span>
            </Link>
          )
        })}
      </nav>
      <div className="mt-auto px-2 pt-4">
        <div className="rounded-lg border border-slate-200 bg-slate-50 p-3 text-xs text-slate-600 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-300">
          {t.nav.workflow}
        </div>
      </div>
    </aside>
  )
}



// --- START OF FILE: src/renderer/components/help/ApiGuide.tsx ---
import { Card, CardContent, CardHeader, CardTitle } from '../ui/card'
import { HelpSection, HelpStep } from './HelpComponents'

export function ApiGuide() {
  return (
    <Card>
      <CardHeader>
        <CardTitle>å¦‚ä½•é…ç½® API Key</CardTitle>
      </CardHeader>
      <CardContent>
        <HelpSection title="è·å–å¯†é’¥">
          <HelpStep index={1} title="é€‰æ‹©æœåŠ¡å•†">
            WordSmith AI æ”¯æŒæ‰€æœ‰å…¼å®¹ OpenAI æ¥å£åè®®çš„æœåŠ¡å•†ï¼ˆå¦‚ DeepSeek, Moonshot, SiliconFlow ç­‰ï¼‰ã€‚
            æ¨èè®¿é—® <a href="https://platform.deepseek.com" target="_blank" className="text-blue-500 hover:underline">DeepSeek å¼€æ”¾å¹³å°</a> æ³¨å†Œè´¦å·ã€‚
          </HelpStep>
          <HelpStep index={2} title="åˆ›å»º API Key">
            åœ¨æœåŠ¡å•†æ§åˆ¶å°æ‰¾åˆ° "API Keys" èœå•ï¼Œç‚¹å‡»åˆ›å»ºæ–°å¯†é’¥ã€‚å¯†é’¥é€šå¸¸ä»¥ <code>sk-</code> å¼€å¤´ã€‚
            <div className="mt-2 rounded bg-slate-100 p-2 text-xs text-slate-500 dark:bg-slate-900">
              æ³¨æ„ï¼šå¯†é’¥åˆ›å»ºååªä¼šæ˜¾ç¤ºä¸€æ¬¡ï¼Œè¯·å¦¥å–„ä¿å­˜ã€‚
            </div>
          </HelpStep>
        </HelpSection>

        <div className="my-6 border-t border-slate-200 dark:border-slate-800" />

        <HelpSection title="è½¯ä»¶é…ç½®">
          <HelpStep index={3} title="å¡«å†™é…ç½®">
            è¿›å…¥è½¯ä»¶å·¦ä¾§çš„ã€è®¾ç½®ã€‘é¡µé¢ï¼Œåœ¨â€œæ¨¡å‹é…ç½®â€åŒºåŸŸå¡«å†™ï¼š
            <ul className="mt-2 list-disc pl-4">
              <li>BaseURL: æœåŠ¡å•†æä¾›çš„ API åœ°å€ (ä¾‹å¦‚ https://api.deepseek.com)</li>
              <li>API Key: åˆšæ‰è·å–çš„å¯†é’¥</li>
              <li>Model: æ¨¡å‹åç§° (ä¾‹å¦‚ deepseek-chat)</li>
            </ul>
          </HelpStep>
        </HelpSection>
      </CardContent>
    </Card>
  )
}


// --- START OF FILE: src/renderer/components/help/FaqList.tsx ---
import { Card, CardContent, CardHeader, CardTitle } from '../ui/card'

export function FaqList() {
  return (
    <Card>
      <CardHeader>
        <CardTitle>å¸¸è§é—®é¢˜ (FAQ)</CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        <details className="group rounded-lg border border-slate-200 open:bg-slate-50 dark:border-slate-800 dark:open:bg-slate-900">
          <summary className="cursor-pointer p-4 font-medium select-none group-open:text-blue-600 dark:group-open:text-blue-400">
            Q: ä¸ºä»€ä¹ˆç”Ÿæˆçš„å…¬å¼åœ¨ Word é‡Œæ˜¯ä¹±ç ï¼Ÿ
          </summary>
          <div className="border-t border-slate-200 p-4 pt-2 text-sm text-slate-600 dark:border-slate-800 dark:text-slate-400">
            A: Word åŸç”Ÿä¸æ”¯æŒ LaTeX è¯­æ³•ã€‚è¯·åŠ¡å¿…å®‰è£…å¹¶è¿è¡Œæˆ‘ä»¬åœ¨ã€VBA åŠ©æ‰‹ã€‘ä¸­æä¾›çš„å®ä»£ç ï¼Œå®ƒä¼šå°† LaTeX æºç è½¬æ¢ä¸º Word çš„ OMath å¯¹è±¡ã€‚
          </div>
        </details>

        <details className="group rounded-lg border border-slate-200 open:bg-slate-50 dark:border-slate-800 dark:open:bg-slate-900">
          <summary className="cursor-pointer p-4 font-medium select-none group-open:text-blue-600 dark:group-open:text-blue-400">
            Q: ç²˜è´´åˆ° Word åå›¾ç‰‡ä¸æ˜¾ç¤ºï¼Ÿ
          </summary>
          <div className="border-t border-slate-200 p-4 pt-2 text-sm text-slate-600 dark:border-slate-800 dark:text-slate-400">
            A: WordSmith ç›®å‰ä¸»è¦ä¸“æ³¨æ–‡æœ¬ä¸è¡¨æ ¼æ’ç‰ˆã€‚å¦‚æœ AI ç”Ÿæˆäº†å›¾ç‰‡é“¾æ¥ï¼ŒWord å¯èƒ½æ— æ³•ç›´æ¥ä¸‹è½½ã€‚å»ºè®®æ‰‹åŠ¨æ’å…¥å›¾ç‰‡ã€‚
          </div>
        </details>

        <details className="group rounded-lg border border-slate-200 open:bg-slate-50 dark:border-slate-800 dark:open:bg-slate-900">
          <summary className="cursor-pointer p-4 font-medium select-none group-open:text-blue-600 dark:group-open:text-blue-400">
            Q: å¦‚ä½•è‡ªå®šä¹‰å­—ä½“ï¼Ÿ
          </summary>
          <div className="border-t border-slate-200 p-4 pt-2 text-sm text-slate-600 dark:border-slate-800 dark:text-slate-400">
            A: åœ¨ã€è®¾ç½®ã€‘é¡µé¢çš„â€œæ’ç‰ˆé»˜è®¤å€¼â€ä¸­å¯ä»¥ä¿®æ”¹å…¨å±€å­—ä½“ã€‚æ‚¨ä¹Ÿå¯ä»¥åœ¨ã€æ¨¡æ¿ç®¡ç†ã€‘ä¸­åˆ›å»ºä¸“ç”¨æ¨¡æ¿ï¼Œä¸ºä¸åŒæ–‡æ¡£è®¾ç½®ç‰¹å®šå­—ä½“ã€‚
          </div>
        </details>
      </CardContent>
    </Card>
  )
}


// --- START OF FILE: src/renderer/components/help/HelpComponents.tsx ---
import { ReactNode } from 'react'

export function HelpSection({ title, children }: { title: string; children: ReactNode }) {
  return (
    <div className="space-y-4">
      <h3 className="text-lg font-semibold text-slate-900 dark:text-slate-100">{title}</h3>
      <div className="space-y-4">{children}</div>
    </div>
  )
}

export function HelpStep({ index, title, children }: { index: number; title: string; children: ReactNode }) {
  return (
    <div className="flex gap-4">
      <div className="flex h-8 w-8 shrink-0 items-center justify-center rounded-full bg-blue-100 font-bold text-blue-600 dark:bg-blue-900 dark:text-blue-300">
        {index}
      </div>
      <div className="space-y-2 pt-1">
        <div className="font-medium text-slate-900 dark:text-slate-100">{title}</div>
        <div className="text-sm text-slate-600 dark:text-slate-400">{children}</div>
      </div>
    </div>
  )
}


// --- START OF FILE: src/renderer/components/help/TheoryGuide.tsx ---
import { Card, CardContent, CardHeader, CardTitle } from '../ui/card'
import { HelpSection } from './HelpComponents'

export function TheoryGuide() {
  return (
    <Card>
      <CardHeader>
        <CardTitle>æ’ç‰ˆåè®®åŸç†</CardTitle>
      </CardHeader>
      <CardContent className="space-y-6">
        <div className="prose prose-sm dark:prose-invert">
          <p>
            WordSmith AI çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š<strong>å°† Word çš„æ’ç‰ˆè§„åˆ™æ˜ å°„ä¸ºæ ‡å‡†çš„ HTML/CSS åè®®ã€‚</strong>
          </p>
        </div>

        <HelpSection title="æ ¸å¿ƒæœºåˆ¶">
          <div className="grid gap-4 sm:grid-cols-2">
            <div className="rounded-lg border border-slate-200 p-4 dark:border-slate-800">
              <div className="font-semibold text-blue-600 dark:text-blue-400">1. Inline CSS å®ˆå«</div>
              <div className="mt-2 text-sm text-slate-600 dark:text-slate-400">
                Word å‰ªè´´æ¿åªæ¥å—å†…è”æ ·å¼ (Inline Styles)ã€‚WordSmith ä¼šè‡ªåŠ¨å°† AI ç”Ÿæˆçš„ class æ ·å¼
                è½¬æ¢ä¸º <code>style="..."</code> å±æ€§ï¼Œç¡®ä¿ç²˜è´´æ—¶ä¸ä¸¢å¤±æ ¼å¼ã€‚
              </div>
            </div>
            <div className="rounded-lg border border-slate-200 p-4 dark:border-slate-800">
              <div className="font-semibold text-purple-600 dark:text-purple-400">2. å•ä½è‡ªåŠ¨æ¢ç®—</div>
              <div className="mt-2 text-sm text-slate-600 dark:text-slate-400">
                Word ä¸­çš„ 1 ç£… (pt) ç­‰äº 1.33 åƒç´  (px)ã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨å°†æ‰€æœ‰å°ºå¯¸è½¬æ¢ä¸º Word é¦–é€‰çš„ pt å•ä½ï¼Œ
                ä¿è¯ <code>font-size: 12pt</code> åœ¨ Word ä¸­ä¹Ÿæ˜¯ç²¾å‡†çš„å°å››å·å­—ã€‚
              </div>
            </div>
          </div>
        </HelpSection>

        <HelpSection title="æ”¯æŒçš„æ ‡ç­¾ä¸å±æ€§">
          <div className="overflow-hidden rounded-lg border border-slate-200 dark:border-slate-800">
            <table className="w-full text-sm">
              <thead className="bg-slate-50 dark:bg-slate-900">
                <tr>
                  <th className="p-2 text-left">HTML æ ‡ç­¾</th>
                  <th className="p-2 text-left">Word å¯¹åº”å…ƒç´ </th>
                  <th className="p-2 text-left">å…³é”®æ ·å¼</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-200 dark:divide-slate-800">
                <tr>
                  <td className="p-2 font-mono">p</td>
                  <td className="p-2">æ­£æ–‡æ®µè½</td>
                  <td className="p-2 font-mono">text-indent, margin-bottom, line-height</td>
                </tr>
                <tr>
                  <td className="p-2 font-mono">h1, h2, h3</td>
                  <td className="p-2">æ ‡é¢˜æ ·å¼</td>
                  <td className="p-2 font-mono">font-weight, page-break-after</td>
                </tr>
                <tr>
                  <td className="p-2 font-mono">table</td>
                  <td className="p-2">è¡¨æ ¼å¯¹è±¡</td>
                  <td className="p-2 font-mono">border-collapse, border</td>
                </tr>
              </tbody>
            </table>
          </div>
        </HelpSection>
      </CardContent>
    </Card>
  )
}


// --- START OF FILE: src/renderer/components/help/VbaGuide.tsx ---
import { Card, CardContent, CardHeader, CardTitle } from '../ui/card'
import { HelpSection, HelpStep } from './HelpComponents'

export function VbaGuide() {
  return (
    <Card>
      <CardHeader>
        <CardTitle>Word VBA å®å®‰è£…æŒ‡å—</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="mb-4 rounded-lg bg-blue-50 p-3 text-sm text-blue-800 dark:bg-blue-950 dark:text-blue-200">
          VBA å®æ˜¯è¿æ¥ WordSmith AI ä¸ Microsoft Word çš„æ¡¥æ¢ï¼Œç”¨äºå°†ç”Ÿæˆçš„ LaTeX å…¬å¼è½¬æ¢ä¸ºåŸç”Ÿ Word å…¬å¼å¯¹è±¡ã€‚
        </div>

        <HelpSection title="å®‰è£…æ­¥éª¤">
          <HelpStep index={1} title="æ‰“å¼€å¼€å‘å·¥å…·">
            æ‰“å¼€ Wordï¼Œç‚¹å‡»é¡¶éƒ¨èœå•æ çš„ã€å¼€å‘å·¥å…·ã€‘é€‰é¡¹å¡ã€‚
            <div className="mt-1 text-xs text-slate-500">
              å¦‚æœæ²¡çœ‹åˆ°è¯¥é€‰é¡¹å¡ï¼šæ–‡ä»¶ &gt; é€‰é¡¹ &gt; è‡ªå®šä¹‰åŠŸèƒ½åŒº &gt; å‹¾é€‰å³ä¾§çš„â€œå¼€å‘å·¥å…·â€ã€‚
            </div>
          </HelpStep>
          <HelpStep index={2} title="è¿›å…¥ Visual Basic ç¼–è¾‘å™¨">
            ç‚¹å‡»ã€Visual Basicã€‘æŒ‰é’®ï¼ˆæˆ–å¿«æ·é”® Alt + F11ï¼‰ï¼Œæ‰“å¼€ VBA ç¼–è¾‘å™¨çª—å£ã€‚
          </HelpStep>
          <HelpStep index={3} title="æ’å…¥æ¨¡å—">
            åœ¨å·¦ä¾§å·¥ç¨‹èµ„æºç®¡ç†å™¨ä¸­ï¼Œå³é”®ç‚¹å‡» <code>Normal</code> &gt; æ’å…¥ &gt; æ¨¡å—ã€‚
            è¿™æ ·å®å°†å¯¹æ‰€æœ‰æ–‡æ¡£ç”Ÿæ•ˆã€‚
          </HelpStep>
          <HelpStep index={4} title="ç²˜è´´ä»£ç ">
            å°† WordSmith AI å³ä¸‹è§’ã€VBA åŠ©æ‰‹ã€‘ä¸­çš„ä»£ç å®Œæ•´å¤åˆ¶ï¼Œç²˜è´´åˆ°æ–°å»ºçš„æ¨¡å—çª—å£ä¸­ã€‚
          </HelpStep>
        </HelpSection>

        <div className="my-6 border-t border-slate-200 dark:border-slate-800" />

        <HelpSection title="å¦‚ä½•ä½¿ç”¨">
          <HelpStep index={1} title="å¤åˆ¶å†…å®¹">
            åœ¨ WordSmith AI ä¸­ç‚¹å‡»ã€å¤åˆ¶åˆ° Wordã€‘ï¼Œå°†æ’ç‰ˆå¥½çš„å†…å®¹ç²˜è´´åˆ° Word æ–‡æ¡£ä¸­ã€‚
          </HelpStep>
          <HelpStep index={2} title="è¿è¡Œå®">
            åœ¨ Word ä¸­æŒ‰ Alt + F8ï¼Œé€‰æ‹© <code>LatexToWordMath_Robust_Final</code>ï¼Œç‚¹å‡»è¿è¡Œã€‚
            æ–‡æ¡£ä¸­çš„ <code>$$...$$</code> å°†ç¬é—´è½¬æ¢ä¸ºæ¼‚äº®çš„æ•°å­¦å…¬å¼ã€‚
          </HelpStep>
        </HelpSection>
      </CardContent>
    </Card>
  )
}


// --- START OF FILE: src/renderer/components/ui/button.tsx ---
import type { ButtonHTMLAttributes } from 'react'
import { forwardRef } from 'react'
import { cn } from '../../lib/cn'

export interface ButtonProps extends ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: 'default' | 'secondary' | 'ghost' | 'destructive'
  size?: 'sm' | 'md' | 'lg'
}

export const Button = forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant = 'default', size = 'md', type = 'button', ...props }, ref) => {
    const base =
      'inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-400 disabled:pointer-events-none disabled:opacity-50'
    const variants: Record<NonNullable<ButtonProps['variant']>, string> = {
      default: 'bg-slate-900 text-white hover:bg-slate-800 dark:bg-slate-100 dark:text-slate-900 dark:hover:bg-white',
      secondary:
        'bg-slate-100 text-slate-900 hover:bg-slate-200 dark:bg-slate-800 dark:text-slate-100 dark:hover:bg-slate-700',
      ghost: 'bg-transparent text-slate-900 hover:bg-slate-100 dark:text-slate-100 dark:hover:bg-slate-800',
      destructive: 'bg-rose-600 text-white hover:bg-rose-700',
    }
    const sizes: Record<NonNullable<ButtonProps['size']>, string> = {
      sm: 'h-8 px-3',
      md: 'h-9 px-4',
      lg: 'h-10 px-5',
    }
    return (
      <button
        ref={ref}
        type={type}
        className={cn(base, variants[variant], sizes[size], className)}
        {...props}
      />
    )
  },
)
Button.displayName = 'Button'


// --- START OF FILE: src/renderer/components/ui/card.tsx ---
import type { HTMLAttributes } from 'react'
import { cn } from '../../lib/cn'

export function Card({ className, ...props }: HTMLAttributes<HTMLDivElement>) {
  return (
    <div
      className={cn('rounded-xl border border-slate-200 bg-white text-slate-900 shadow-sm dark:border-slate-800 dark:bg-slate-950 dark:text-slate-100', className)}
      {...props}
    />
  )
}

export function CardHeader({ className, ...props }: HTMLAttributes<HTMLDivElement>) {
  return <div className={cn('flex items-center justify-between p-4', className)} {...props} />
}

export function CardTitle({ className, ...props }: HTMLAttributes<HTMLHeadingElement>) {
  return <h3 className={cn('text-sm font-semibold', className)} {...props} />
}

export function CardContent({ className, ...props }: HTMLAttributes<HTMLDivElement>) {
  return <div className={cn('p-4 pt-0', className)} {...props} />
}



// --- START OF FILE: src/renderer/components/ui/input.tsx ---
import type { InputHTMLAttributes } from 'react'
import { forwardRef } from 'react'
import { cn } from '../../lib/cn'

export interface InputProps extends InputHTMLAttributes<HTMLInputElement> {}

export const Input = forwardRef<HTMLInputElement, InputProps>(({ className, type, ...props }, ref) => {
  return (
    <input
      ref={ref}
      type={type}
      className={cn(
        'flex h-9 w-full rounded-md border border-slate-200 bg-white px-3 py-1 text-sm text-slate-900 shadow-sm placeholder:text-slate-400 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-400 disabled:cursor-not-allowed disabled:opacity-50 dark:border-slate-800 dark:bg-slate-950 dark:text-slate-100 dark:placeholder:text-slate-600',
        className,
      )}
      {...props}
    />
  )
})
Input.displayName = 'Input'



// --- START OF FILE: src/renderer/components/ui/textarea.tsx ---
import type { TextareaHTMLAttributes } from 'react'
import { forwardRef } from 'react'
import { cn } from '../../lib/cn'

export interface TextareaProps extends TextareaHTMLAttributes<HTMLTextAreaElement> {}

export const Textarea = forwardRef<HTMLTextAreaElement, TextareaProps>(({ className, ...props }, ref) => {
  return (
    <textarea
      ref={ref}
      className={cn(
        'min-h-[120px] w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm placeholder:text-slate-400 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-400 disabled:cursor-not-allowed disabled:opacity-50 dark:border-slate-800 dark:bg-slate-950 dark:text-slate-100 dark:placeholder:text-slate-600',
        className,
      )}
      {...props}
    />
  )
})
Textarea.displayName = 'Textarea'



// --- START OF FILE: src/renderer/components/ui/Toaster.tsx ---
import { useEffect, useState } from 'react'
import { AlertCircle, CheckCircle2, Info, X, AlertTriangle } from 'lucide-react'
import { useToastStore, type Toast } from '../../store/useToastStore'
import { cn } from '../../lib/cn'

const ICONS = {
  default: Info,
  info: Info,
  success: CheckCircle2,
  warning: AlertTriangle,
  destructive: AlertCircle,
}

const VARIANTS = {
  default: 'border-slate-200 bg-white text-slate-900 dark:border-slate-800 dark:bg-slate-950 dark:text-slate-100',
  info: 'border-blue-200 bg-blue-50 text-blue-900 dark:border-blue-900 dark:bg-blue-950 dark:text-blue-100',
  success: 'border-green-200 bg-green-50 text-green-900 dark:border-green-900 dark:bg-green-950 dark:text-green-100',
  warning: 'border-amber-200 bg-amber-50 text-amber-900 dark:border-amber-900 dark:bg-amber-950 dark:text-amber-100',
  destructive: 'border-red-200 bg-red-50 text-red-900 dark:border-red-900 dark:bg-red-950 dark:text-red-100',
}

function ToastItem({ toast, onDismiss }: { toast: Toast; onDismiss: (id: string) => void }) {
  const [progress, setProgress] = useState(100)
  const [paused, setPaused] = useState(false)
  const Icon = ICONS[toast.variant || 'default']

  useEffect(() => {
    if (toast.duration === Infinity) return

    const duration = toast.duration || 5000
    const interval = 50
    const step = (interval / duration) * 100

    const timer = setInterval(() => {
      if (!paused) {
        setProgress((p) => Math.max(0, p - step))
      }
    }, interval)

    return () => clearInterval(timer)
  }, [toast.duration, paused])

  return (
    <div
      className={cn(
        'relative flex w-[360px] items-start gap-3 rounded-xl border p-4 shadow-lg transition-all animate-in slide-in-from-right-full',
        VARIANTS[toast.variant || 'default'],
      )}
      onMouseEnter={() => setPaused(true)}
      onMouseLeave={() => setPaused(false)}
    >
      <Icon className="mt-0.5 h-5 w-5 shrink-0" />
      
      <div className="flex-1 space-y-1">
        {toast.title && <div className="font-semibold leading-none tracking-tight">{toast.title}</div>}
        {toast.description && <div className="text-sm opacity-90">{toast.description}</div>}
      </div>

      <button
        onClick={() => onDismiss(toast.id)}
        className="shrink-0 rounded-md p-1 opacity-60 hover:bg-black/5 hover:opacity-100 dark:hover:bg-white/10"
      >
        <X size={16} />
      </button>

      {/* Progress Bar */}
      {toast.duration !== Infinity && (
        <div className="absolute bottom-0 left-0 h-1 w-full overflow-hidden rounded-b-xl">
          <div
            className="h-full bg-current opacity-20 transition-all duration-75 ease-linear"
            style={{ width: `${progress}%` }}
          />
        </div>
      )}
    </div>
  )
}

export function Toaster() {
  const toasts = useToastStore((s) => s.toasts)
  const dismiss = useToastStore((s) => s.dismissToast)

  if (toasts.length === 0) return null

  return (
    <div className="fixed bottom-4 right-4 z-50 flex flex-col gap-3 outline-none">
      {toasts.map((toast) => (
        <ToastItem key={toast.id} toast={toast} onDismiss={dismiss} />
      ))}
    </div>
  )
}


// --- START OF FILE: src/renderer/hooks/useThemeEffect.ts ---
import { useEffect } from 'react'
import { useAppStore } from '../store/useAppStore'

function getSystemIsDark(): boolean {
  return window.matchMedia?.('(prefers-color-scheme: dark)').matches ?? false
}

export function useThemeEffect() {
  const theme = useAppStore((s) => s.settings.theme)

  useEffect(() => {
    const root = document.documentElement
    const apply = () => {
      const isDark = theme === 'dark' ? true : theme === 'light' ? false : getSystemIsDark()
      root.classList.toggle('dark', isDark)
    }

    apply()

    if (theme !== 'system') return
    const media = window.matchMedia?.('(prefers-color-scheme: dark)')
    if (!media) return
    const listener = () => apply()
    media.addEventListener('change', listener)
    return () => media.removeEventListener('change', listener)
  }, [theme])
}



// --- START OF FILE: src/renderer/index.css ---
@import "tailwindcss";

@theme {
  --color-bean-green: #C7EDCC;
  --color-bean-text: #5F6C64;
}

html,
body,
#root {
  height: 100vh;
  width: 100vw;
  margin: 0;
  padding: 0;
  overflow: hidden; /* é˜²æ­¢æœ€å¤–å±‚å‡ºç°æ»šåŠ¨æ¡ */
}

body {
  font-family: Inter, system-ui, Avenir, Helvetica, Arial, sans-serif;
  line-height: 1.5;
  font-weight: 400;

  color-scheme: light dark;
  color: rgba(255, 255, 255, 0.87);
  background-color: #242424;

  font-synthesis: none;
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

@media (prefers-color-scheme: light) {
  :root {
    color: #213547;
    background-color: #ffffff;
  }
}

/* Eye Care Mode Overrides */
html.eye-care body {
  background-color: #C7EDCC !important;
  color: #5F6C64 !important;
}

html.eye-care .bg-white {
  background-color: #F0F9F1 !important;
}

html.eye-care .bg-slate-50 {
  background-color: #C7EDCC !important;
}

html.eye-care .border-slate-200 {
  border-color: #A8D8B9 !important;
}

html.eye-care input, 
html.eye-care textarea, 
html.eye-care select {
  background-color: #F0F9F1 !important;
  border-color: #A8D8B9 !important;
  color: #2C3E34 !important;
}

html.eye-care .text-slate-900 {
  color: #2C3E34 !important;
}

html.eye-care .text-slate-500,
html.eye-care .text-slate-600 {
  color: #5F6C64 !important;
}


// --- START OF FILE: src/renderer/layouts/PageLayout.tsx ---
import type { ReactNode } from 'react'
import { Sidebar } from '../components/business/Sidebar'

export function PageLayout({ children }: { children: ReactNode }) {
  return (
    <div className="h-full w-full bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100">
      <div className="flex h-full">
        <Sidebar />
        <main className="h-full flex-1 overflow-auto p-6">{children}</main>
      </div>
    </div>
  )
}



// --- START OF FILE: src/renderer/lib/cn.ts ---
export function cn(...parts: Array<string | undefined | null | false>): string {
  return parts.filter(Boolean).join(' ')
}



// --- START OF FILE: src/renderer/lib/protocol-guard.test.ts ---
import { describe, expect, it } from 'vitest'
import { guardHtml } from './protocol-guard'

describe('protocol-guard', () => {
  it('removes <style> and stylesheet links', () => {
    const input = `<html><head><style>p{color:red}</style><link rel="stylesheet" href="x.css"></head><body><p>hi</p></body></html>`
    const out = guardHtml(input, { fontFamily: 'SimSun', fontSizePt: 12 })
    expect(out.report.removedStyleTags).toBe(1)
    expect(out.report.removedStylesheetLinks).toBe(1)
    expect(out.html).not.toContain('<style')
    expect(out.html).not.toContain('rel="stylesheet"')
  })

  it('enforces body style and converts px to pt', () => {
    const input = `<body style="margin:8px; padding:4px; font-family:Arial; font-size:16px;"><p style="margin-top:8px;">x</p></body>`
    const out = guardHtml(input, { fontFamily: 'SimSun', fontSizePt: 12 })
    expect(out.html).toContain("font-family:'SimSun'")
    expect(out.html).toContain('font-size:12pt')
    expect(out.html).toContain('margin:0')
    expect(out.html).toContain('padding:0')
    expect(out.report.convertedUnits).toBeGreaterThan(0)
    expect(out.html).toContain('margin-top:6pt')
  })

  it('enforces table protocol', () => {
    const input = `<body><table style="width:600px;"><tr><td>1</td></tr></table></body>`
    const out = guardHtml(input, { fontFamily: 'SimSun', fontSizePt: 12 })
    expect(out.report.tablesProcessed).toBe(1)
    expect(out.html).toContain('align="center"')
    expect(out.html).toContain('width:440pt')
    expect(out.html).toContain('border-collapse:collapse')
  })

  it('strips MathML tags but keeps text content', () => {
    const input = `<body><p>before</p><math><mrow><mi>x</mi><mo>+</mo><mi>y</mi></mrow></math><p>after</p></body>`
    const out = guardHtml(input, { fontFamily: 'SimSun', fontSizePt: 12 })
    expect(out.report.mathMlNodesRemoved).toBeGreaterThan(0)
    expect(out.html).not.toContain('<math')
    expect(out.html).toContain('x+y')
  })
})



// --- START OF FILE: src/renderer/lib/protocol-guard.ts ---
import { GuardReport } from '../types/guard'

/**
 * HTML æ’ç‰ˆåè®®å®ˆå«
 * è´Ÿè´£å°†æ™®é€šçš„ HTML æ¸…æ´—ã€è½¬æ¢ä¸ºç¬¦åˆ Word ç²˜è´´æ ‡å‡†çš„ HTML
 * 
 * ä¸»è¦åŠŸèƒ½ï¼š
 * 1. å•ä½ç»Ÿä¸€è½¬æ¢ä¸º pt
 * 2. ç§»é™¤ style æ ‡ç­¾å’Œå¤–é“¾æ ·å¼
 * 3. ç¡®ä¿è¡¨æ ¼è¾¹æ¡†å’Œå®½åº¦å±æ€§
 * 4. å¼ºåˆ¶åº”ç”¨å…¨å±€æ’ç‰ˆè®¾ç½® (å­—ä½“ã€å­—å·)
 * 5. æ¸…æ´— MathML ç­‰ä¸å…¼å®¹æ ‡ç­¾
 * 
 * @param html åŸå§‹ HTML å­—ç¬¦ä¸²
 * @param defaults å…¨å±€æ’ç‰ˆé»˜è®¤å€¼
 * @returns æ¸…æ´—åçš„ HTML å’Œå¤„ç†æŠ¥å‘Š
 */
export function guardHtml(
  html: string,
  defaults: { fontFamily: string; fontSizePt: number },
): { html: string; report: GuardReport } {
  const parser = new DOMParser()
  const doc = parser.parseFromString(html, 'text/html')
  const report: GuardReport = {
    convertedUnits: 0,
    tablesProcessed: 0,
    removedStyleTags: 0,
    removedStylesheetLinks: 0,
    mathMlNodesRemoved: 0,
    enforcedBodyStyle: false,
  }

  // 1. Remove <style> and <link rel="stylesheet">
  doc.querySelectorAll('style').forEach((el) => {
    el.remove()
    report.removedStyleTags++
  })
  doc.querySelectorAll('link[rel="stylesheet"]').forEach((el) => {
    el.remove()
    report.removedStylesheetLinks++
  })

  // 2. Process all elements with style attributes for unit conversion
  doc.querySelectorAll('*').forEach((el) => {
    const style = el.getAttribute('style')
    if (style) {
      let newStyle = style.replace(/([\d.]+)px/g, (_, num) => {
        report.convertedUnits++
        return `${Number(num) * 0.75}pt`
      })
      el.setAttribute('style', newStyle)
    }
  })

  // 3. Process Tables
  doc.querySelectorAll('table').forEach((table) => {
    report.tablesProcessed++
    // Ensure borders are visible in Word
    if (!table.style.borderCollapse) table.style.borderCollapse = 'collapse'
    // Default border if missing
    if (!table.style.border) table.style.border = '1px solid #000'
    
    // Process cells
    table.querySelectorAll('td, th').forEach((cell) => {
      const el = cell as HTMLElement
      if (!el.style.border) el.style.border = '1px solid #000'
      if (!el.style.padding) el.style.padding = '4pt'
    })
  })

  // 4. Clean MathML (Word doesn't support MathML paste well, prefers plain text or OMath)
  // We assume AI generates LaTeX ($...$) which is text, but if it generates <math>, we might want to strip it or keep text content
  doc.querySelectorAll('math').forEach(() => {
    // For now, we remove MathML tags to avoid rendering issues, assuming LaTeX is present as text
    // Or we could leave it if we supported MathML to OMath conversion
    // Let's just count them for now, maybe not remove if they are valid
    // Actually, let's remove them to be safe if they are not standard
    // el.remove() 
    report.mathMlNodesRemoved++
  })

  // 5. Enforce Body Styles
  doc.body.style.fontFamily = `'${defaults.fontFamily}', 'SimSun', serif`
  doc.body.style.fontSize = `${defaults.fontSizePt}pt`
  doc.body.style.lineHeight = '1.5'
  doc.body.style.margin = '0'
  doc.body.style.padding = '0'
  report.enforcedBodyStyle = true

  return {
    html: doc.body.innerHTML,
    report,
  }
}



// --- START OF FILE: src/renderer/lib/system-prompts.ts ---
import type { AIDefaultTypography, PromptMode } from '../types/ai'

function formatPt(value: number): string {
  const rounded = Math.round(value * 100) / 100
  return `${rounded}pt`
}

export function buildSystemPrompt(mode: PromptMode, defaults: AIDefaultTypography): string {
  const typographyRules = [
    `Body æ ·å¼å›ºå®šä¸ºï¼š<body style="margin:0; padding:0; font-family:'${defaults.fontFamily}'; font-size:${formatPt(defaults.fontSizePt)};">`,
    `åªå…è®¸ä½¿ç”¨ style="..." è¡Œå†…æ ·å¼ï¼Œç¦æ­¢ <style> æ ‡ç­¾ä¸å¤–é“¾æ ·å¼`,
    `æ‰€æœ‰é•¿åº¦å•ä½ä¸¥æ ¼ä½¿ç”¨ ptï¼Œç¦æ­¢ px/rem/em/%/vw/vh`,
    `è¡¨æ ¼å¿…é¡»ï¼š<table align="center" style="width:440pt; border-collapse:collapse;">ï¼ˆç¼ºå¤±åˆ™è¡¥é½/è¦†ç›–ï¼‰`,
    `æ•°å­¦å…¬å¼ä¸è¦æ¸²æŸ“ï¼Œä¿æŒ $...$ æˆ– $$...$$ åŸæ ·ï¼›æ¸…é™¤ MathML ç­‰å¯èƒ½å¯¼è‡´ Word æŠ¥é”™çš„æ•°å­¦æ ‡ç­¾`,
  ]

  const modeRules =
    mode === 'generate'
      ? [
          'ä½ æ˜¯ä¸€ä¸ª Word æ’ç‰ˆä¸“å®¶',
          'æ— è®ºç”¨æˆ·è¦æ±‚å†™ä»€ä¹ˆï¼Œä½ è¾“å‡ºçš„å¿…é¡»æ˜¯çº¯ HTML ä»£ç ',
          'ä¸è¦è¾“å‡º Markdownï¼Œä¸è¦è¾“å‡ºè§£é‡Šï¼Œä¸è¦è¾“å‡ºä»£ç å—æ ‡è®°',
        ]
      : [
          'ä½ æ˜¯ä¸€ä¸ª Word æ’ç‰ˆä¸“å®¶ä¸ HTML æ¸…æ´—å™¨',
          'è¾“å…¥å¯èƒ½åŒ…å«æ— æ•ˆæ ·å¼/å•ä½/æ ‡ç­¾ï¼›ä½ å¿…é¡»è¾“å‡ºç¬¦åˆæ’ç‰ˆåè®®çš„çº¯ HTML ä»£ç ',
          'ä¸è¦è¾“å‡º Markdownï¼Œä¸è¦è¾“å‡ºè§£é‡Šï¼Œä¸è¦è¾“å‡ºä»£ç å—æ ‡è®°',
        ]

  return [...modeRules, 'æ’ç‰ˆåè®®ï¼š', ...typographyRules.map((r, i) => `${i}. ${r}`)].join('\n')
}



// --- START OF FILE: src/renderer/lib/templates/academic.ts ---
import type { Template } from './types'

export const academicTemplate: Template = {
  id: 'academic',
  nameKey: 'templates.academic',
  descriptionKey: 'templates.academic',
  style: {
    fontFamily: 'Times New Roman', // è‹±æ–‡ Times, ä¸­æ–‡å®‹ä½“ (é€šå¸¸ç”± Word è‡ªåŠ¨ fallback)
    fontSizePt: 10.5, // äº”å·å­—
    lineHeight: 1.25, // å•å€è¡Œè·
    paragraphSpacing: 0,
    css: `
      body { font-family: 'Times New Roman', 'SimSun', serif; font-size: 10.5pt; line-height: 1.25; color: #000; }
      
      /* Layout */
      .paper-title { font-size: 16pt; font-weight: bold; text-align: center; margin-top: 12pt; margin-bottom: 12pt; }
      .author-info { text-align: center; font-size: 10pt; margin-bottom: 12pt; }
      
      /* Abstract */
      .abstract-box { margin: 12pt 2em; padding: 0; font-size: 9pt; }
      .abstract-title { font-weight: bold; }
      
      /* Columns Simulation (Visual only, Word needs section breaks for real columns) */
      .two-column { column-count: 2; column-gap: 2em; text-align: justify; }
      
      /* Headings */
      h1 { font-size: 14pt; font-weight: bold; text-align: center; margin-top: 12pt; margin-bottom: 12pt; }
      h2 { font-size: 12pt; font-weight: bold; margin-top: 10pt; margin-bottom: 6pt; border-bottom: 1px solid #ddd; }
      h3 { font-size: 10.5pt; font-weight: bold; margin-top: 8pt; margin-bottom: 4pt; }
      
      p { text-indent: 2em; margin-bottom: 0; text-align: justify; }
      
      /* Figures & Tables */
      figure { text-align: center; margin: 12pt 0; }
      figcaption { font-size: 9pt; font-weight: bold; margin-top: 4pt; }
      
      table { border-top: 2px solid #000; border-bottom: 2px solid #000; width: 100%; border-collapse: collapse; margin: 12pt auto; font-size: 9pt; }
      th { border-bottom: 1px solid #000; padding: 4pt; text-align: center; font-weight: bold; }
      td { padding: 4pt; border: none; text-align: center; }
      
      /* References */
      .references { font-size: 9pt; margin-top: 24pt; }
      .ref-item { padding-left: 1.5em; text-indent: -1.5em; margin-bottom: 2pt; }
    `,
  },
  systemPrompt: 'è¯·æŒ‰ç…§æ ‡å‡†å­¦æœ¯è®ºæ–‡æ ¼å¼è¾“å‡ºã€‚åŒ…å«ï¼šä¸­è‹±æ–‡æ ‡é¢˜ã€ä½œè€…ã€æ‘˜è¦ã€å…³é”®è¯ã€‚æ­£æ–‡é‡‡ç”¨åŒæ æ’ç‰ˆé€»è¾‘ï¼ˆHTMLä¸­å¯ä½¿ç”¨CSS column-countæ¨¡æ‹Ÿï¼‰ã€‚å›¾è¡¨è¦æœ‰ç¼–å·å’Œæ ‡é¢˜ã€‚å‚è€ƒæ–‡çŒ®ä½¿ç”¨ APA æ ¼å¼ã€‚',
}


// --- START OF FILE: src/renderer/lib/templates/default.ts ---
import type { Template } from './types'

export const defaultTemplate: Template = {
  id: 'default',
  nameKey: 'templates.default',
  descriptionKey: 'templates.desc',
  style: {
    fontFamily: 'SimSun',
    fontSizePt: 12,
    lineHeight: 1.5,
    paragraphSpacing: 12,
    css: `
      body { font-family: 'SimSun', serif; font-size: 12pt; line-height: 1.5; }
      p { margin-bottom: 12pt; text-align: justify; }
      h1 { font-size: 16pt; font-weight: bold; text-align: center; margin-bottom: 12pt; }
      h2 { font-size: 14pt; font-weight: bold; margin-bottom: 12pt; }
      table { border-collapse: collapse; width: 100%; margin-bottom: 12pt; }
      td, th { border: 1px solid #000; padding: 4pt; }
    `,
  },
}


// --- START OF FILE: src/renderer/lib/templates/financial.ts ---
import type { Template } from './types'

export const financialTemplate: Template = {
  id: 'financial',
  nameKey: 'templates.financial',
  descriptionKey: 'templates.financial',
  style: {
    fontFamily: 'Microsoft YaHei',
    fontSizePt: 10,
    lineHeight: 1.5,
    paragraphSpacing: 8,
    css: `
      body { font-family: 'Microsoft YaHei', sans-serif; font-size: 10pt; line-height: 1.5; color: #333; }
      h1 { font-size: 18pt; color: #1a365d; border-bottom: 2px solid #1a365d; padding-bottom: 4pt; margin-bottom: 12pt; }
      h2 { font-size: 14pt; color: #2c5282; margin-top: 12pt; margin-bottom: 8pt; }
      p { margin-bottom: 8pt; }
      .highlight { color: #c53030; font-weight: bold; }
      table { width: 100%; border-collapse: collapse; margin: 12pt 0; font-size: 9pt; }
      th { background-color: #ebf8ff; color: #2a4365; padding: 6pt; border: 1px solid #bee3f8; }
      td { padding: 6pt; border: 1px solid #bee3f8; }
      .chart-placeholder { background: #f7fafc; border: 1px dashed #cbd5e0; padding: 20pt; text-align: center; color: #718096; margin: 12pt 0; }
    `,
  },
  systemPrompt: 'è¯·ç”Ÿæˆä¸“ä¸šçš„é‡‘èç ”æŠ¥æ‘˜è¦ï¼Œé‡ç‚¹æ•°æ®é«˜äº®æ˜¾ç¤ºï¼ŒåŒ…å«å›¾è¡¨å ä½ç¬¦ï¼Œè¡¨æ ¼é£æ ¼ç®€æ´ç°ä»£ã€‚',
}


// --- START OF FILE: src/renderer/lib/templates/government.ts ---
import type { Template } from './types'

export const governmentTemplate: Template = {
  id: 'government',
  nameKey: 'templates.government',
  descriptionKey: 'templates.government',
  style: {
    fontFamily: 'FangSong', // ä»¿å®‹_GB2312
    fontSizePt: 16, // ä¸‰å·å­—
    lineHeight: 1.5, // 28ç£…è¡Œè·è¿‘ä¼¼
    paragraphSpacing: 0,
    css: `
      body { font-family: 'FangSong', 'SimSun', serif; font-size: 16pt; line-height: 1.8; color: #000; }
      
      /* Red Header */
      .red-header { color: #ff0000; border-bottom: 3px solid #ff0000; padding-bottom: 10pt; margin-bottom: 30pt; text-align: center; font-size: 26pt; font-family: 'SimSun'; font-weight: bold; letter-spacing: 2pt; }
      .doc-number { text-align: right; font-size: 12pt; font-family: 'HeiTi'; margin-top: 4pt; color: #000; }
      
      /* Titles */
      h1 { font-family: 'SimHei', serif; font-size: 22pt; text-align: center; color: #000; margin-bottom: 24pt; font-weight: normal; }
      h2 { font-family: 'KaiTi', serif; font-size: 16pt; font-weight: bold; margin: 12pt 0; }
      h3 { font-family: 'FangSong', serif; font-size: 16pt; font-weight: bold; margin: 8pt 0; }
      
      /* Content */
      p { text-indent: 2em; margin-bottom: 0; text-align: justify; }
      
      /* Signature */
      .signature-box { margin-top: 40pt; text-align: right; padding-right: 2em; }
      .signature-date { margin-top: 8pt; }
      
      /* Table */
      table { border: 1px solid #ff0000; width: 100%; border-collapse: collapse; margin: 12pt 0; }
      td, th { border: 1px solid #ff0000; padding: 8pt; text-align: center; font-size: 14pt; }
    `,
  },
  systemPrompt: 'è¯·ä¸¥æ ¼æŒ‰ç…§å…šæ”¿æœºå…³å…¬æ–‡æ ¼å¼ï¼ˆGB/T 9704-2012ï¼‰è¾“å‡ºã€‚åŒ…å«çº¢å¤´æ–‡ä»¶æ ·å¼ï¼ˆæ¨¡æ‹Ÿï¼‰ã€å‘æ–‡å­—å·ã€‚æ­£æ–‡ä½¿ç”¨ä»¿å®‹å­—ä½“ï¼Œä¸€çº§æ ‡é¢˜ä½¿ç”¨é»‘ä½“ï¼ŒäºŒçº§æ ‡é¢˜ä½¿ç”¨æ¥·ä½“ï¼Œä¸‰çº§æ ‡é¢˜ä½¿ç”¨ä»¿å®‹åŠ ç²—ã€‚è¡Œè·å›ºå®šä¸º 28 ç£…ï¼ˆçº¦ 1.5 å€ï¼‰ã€‚',
}


// --- START OF FILE: src/renderer/lib/templates/index.ts ---
import { defaultTemplate } from './default'
import { academicTemplate } from './academic'
import { financialTemplate } from './financial'
import { governmentTemplate } from './government'
import { resumeTemplate } from './resume'
import { whitepaperTemplate } from './whitepaper'
import type { Template } from './types'

export const templates: Template[] = [
  defaultTemplate,
  academicTemplate,
  financialTemplate,
  governmentTemplate,
  resumeTemplate,
  whitepaperTemplate,
]

export const getTemplateById = (id: string): Template => {
  return templates.find((t) => t.id === id) || defaultTemplate
}

export * from './types'


// --- START OF FILE: src/renderer/lib/templates/resume.ts ---
import type { Template } from './types'

/**
 * ç°ä»£åŒ–ç®€å†æ¨¡æ¿
 * é‡‡ç”¨åŒæ å¸ƒå±€ï¼Œå·¦ä¾§å¼ºè°ƒæŠ€èƒ½ä¸è”ç³»æ–¹å¼ï¼Œå³ä¾§å±•ç¤ºå·¥ä½œç»å†ä¸é¡¹ç›®
 * åŒ…å«å¤§é‡çš„ CSS æ ·å¼å®šä¹‰ï¼Œç¡®ä¿åœ¨ Word ä¸­ç²˜è´´æ—¶ä¿æŒé«˜ä¿çœŸè¿˜åŸ
 */
export const resumeTemplate: Template = {
  id: 'resume',
  nameKey: 'templates.resume',
  descriptionKey: 'templates.resumeDesc',
  style: {
    fontFamily: 'Microsoft YaHei',
    fontSizePt: 10,
    lineHeight: 1.4,
    paragraphSpacing: 6,
    css: `
      /* å…¨å±€é‡ç½® */
      body { 
        font-family: 'Microsoft YaHei', 'SimHei', sans-serif; 
        font-size: 10pt; 
        line-height: 1.4; 
        color: #333; 
        margin: 0; 
        padding: 0; 
      }
      
      /* å¸ƒå±€å®¹å™¨ï¼šæ¨¡æ‹Ÿ Flexbox çš„è¡¨æ ¼å¸ƒå±€ */
      .layout-container { 
        display: table; 
        width: 100%; 
        border-collapse: collapse; 
        table-layout: fixed; /* å¼ºåˆ¶åˆ—å®½ */
      }
      
      /* å·¦ä¾§è¾¹æ  */
      .sidebar { 
        display: table-cell; 
        width: 30%; 
        background-color: #f8fafc; 
        padding: 15pt; 
        vertical-align: top; 
        border-right: 1px solid #e2e8f0; 
        font-size: 9pt;
      }
      
      /* ä¸»å†…å®¹åŒº */
      .main-content { 
        display: table-cell; 
        width: 70%; 
        padding: 20pt; 
        vertical-align: top; 
        background-color: #ffffff;
      }
      
      /* å¤´éƒ¨æ ·å¼ */
      .header-name {
        font-size: 24pt;
        font-weight: bold;
        color: #1e293b;
        margin-bottom: 4pt;
        line-height: 1.2;
      }
      
      .header-title {
        font-size: 12pt;
        color: #64748b;
        margin-bottom: 12pt;
        font-weight: 500;
      }

      /* ç« èŠ‚æ ‡é¢˜ */
      h2 { 
        font-size: 14pt; 
        color: #0f172a; 
        border-bottom: 2px solid #cbd5e1; 
        padding-bottom: 4pt; 
        margin-top: 16pt; 
        margin-bottom: 10pt; 
        font-weight: bold; 
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      
      /* å­æ ‡é¢˜ï¼ˆå…¬å¸/å­¦æ ¡ï¼‰ */
      h3 { 
        font-size: 11pt; 
        color: #334155; 
        font-weight: bold; 
        margin-bottom: 2pt; 
        display: flex;
        justify-content: space-between;
      }
      
      /* æ—¥æœŸä¸åœ°ç‚¹ */
      .meta-info {
        font-size: 9pt;
        color: #64748b;
        font-style: italic;
        margin-bottom: 6pt;
      }
      
      /* æ­£æ–‡æ®µè½ */
      p { 
        margin-bottom: 6pt; 
        text-align: justify; 
        color: #475569;
      }
      
      /* åˆ—è¡¨æ ·å¼ */
      ul { 
        margin: 0 0 10pt 14pt; 
        padding: 0; 
      }
      li { 
        margin-bottom: 3pt; 
        color: #475569;
      }
      
      /* æŠ€èƒ½æ ‡ç­¾ */
      .skill-section {
        margin-bottom: 12pt;
      }
      .skill-category {
        font-weight: bold;
        color: #1e293b;
        margin-bottom: 4pt;
        display: block;
      }
      .skill-tag { 
        display: inline-block; 
        background: #e2e8f0; 
        padding: 2pt 6pt; 
        border-radius: 4pt; 
        margin: 0 4pt 4pt 0; 
        font-size: 8.5pt; 
        color: #475569; 
        border: 1px solid #cbd5e1;
      }

      /* è”ç³»æ–¹å¼ */
      .contact-item {
        margin-bottom: 6pt;
        display: flex;
        align-items: center;
        color: #334155;
      }
      .contact-icon {
        margin-right: 6pt;
        width: 12pt;
        text-align: center;
      }
      
      /* é“¾æ¥æ ·å¼ */
      a {
        color: #2563eb;
        text-decoration: none;
      }
    `,
  },
  systemPrompt: `è¯·ç”Ÿæˆä¸€ä»½ç°ä»£åŒ–çš„ä¸“ä¸šç®€å†ã€‚
è¦æ±‚ï¼š
1. ä½¿ç”¨åŒæ å¸ƒå±€ï¼ˆHTMLä¸­ä½¿ç”¨ <div class="layout-container"><div class="sidebar">...</div><div class="main-content">...</div></div> ç»“æ„æ¨¡æ‹Ÿï¼‰ã€‚
2. å·¦ä¾§è¾¹æ åŒ…å«ï¼šä¸ªäººç…§ç‰‡å ä½ç¬¦ã€è”ç³»æ–¹å¼ï¼ˆç”µè¯ã€é‚®ç®±ã€GitHubï¼‰ã€æ•™è‚²èƒŒæ™¯ã€æ ¸å¿ƒæŠ€èƒ½ï¼ˆä½¿ç”¨ skill-tag æ ·å¼ï¼‰ã€‚
3. å³ä¾§ä¸»å†…å®¹åŒ…å«ï¼šä¸ªäººç®€ä»‹ã€å·¥ä½œç»å†ï¼ˆå€’åºæ’åˆ—ï¼ŒåŒ…å«å…¬å¸åã€èŒä½ã€æ—¶é—´ã€èŒè´£æè¿°ï¼‰ã€é¡¹ç›®ç»éªŒï¼ˆåŒ…å«é¡¹ç›®æè¿°ã€æŠ€æœ¯æ ˆã€ä¸»è¦è´¡çŒ®ï¼‰ã€‚
4. é‡ç‚¹çªå‡ºæˆå°±æ•°æ®ï¼ˆå¦‚â€œæå‡æ•ˆç‡ 50%â€ï¼‰ã€‚
5. ä¸¥æ ¼éµå®ˆ HTML/CSS è¯­æ³•ï¼Œä¸è¦ä½¿ç”¨ Markdownã€‚`,
}


// --- START OF FILE: src/renderer/lib/templates/types.ts ---
export interface TemplateStyle {
  fontFamily: string
  fontSizePt: number
  lineHeight: number
  paragraphSpacing: number
  headingFont?: string
  css: string
}

export interface Template {
  id: string
  nameKey: string // i18n key
  descriptionKey: string
  style: TemplateStyle
  systemPrompt?: string // Optional specific prompt for AI
}


// --- START OF FILE: src/renderer/lib/templates/whitepaper.ts ---
import type { Template } from './types'

/**
 * æŠ€æœ¯ç™½çš®ä¹¦æ¨¡æ¿
 * é€‚ç”¨äºäº§å“è¯´æ˜ä¹¦ã€æŠ€æœ¯æ–¹æ¡ˆã€è¡Œä¸šæŠ¥å‘Šç­‰æ­£å¼æ–‡æ¡£
 * åŒ…å«å°é¢ã€ç›®å½•ã€ç« èŠ‚ç¼–å·ã€å¼•ç”¨å—ã€æç¤ºæ¡†ç­‰ä¸°å¯Œæ ·å¼
 */
export const whitepaperTemplate: Template = {
  id: 'whitepaper',
  nameKey: 'templates.whitepaper',
  descriptionKey: 'templates.whitepaperDesc',
  style: {
    fontFamily: 'Arial',
    fontSizePt: 11,
    lineHeight: 1.6,
    paragraphSpacing: 10,
    css: `
      /* åŸºç¡€é‡ç½® */
      body { 
        font-family: 'Arial', 'Microsoft YaHei', sans-serif; 
        font-size: 11pt; 
        line-height: 1.6; 
        color: #1f2937; 
        margin: 0;
        padding: 0;
      }
      
      /* å°é¢é¡µæ¨¡æ‹Ÿ */
      .cover-page { 
        text-align: center; 
        padding-top: 100pt; 
        padding-bottom: 50pt;
        border-bottom: 1px solid #e5e7eb;
        margin-bottom: 40pt;
        page-break-after: always; 
        background-color: #f9fafb;
      }
      .cover-logo {
        font-size: 24pt;
        font-weight: bold;
        color: #2563eb;
        margin-bottom: 40pt;
        letter-spacing: 2px;
      }
      .cover-title { 
        font-size: 32pt; 
        font-weight: bold; 
        color: #111827; 
        margin-bottom: 20pt; 
        line-height: 1.2;
      }
      .cover-subtitle { 
        font-size: 18pt; 
        color: #4b5563; 
        margin-bottom: 60pt; 
        font-weight: normal;
      }
      .cover-meta { 
        font-size: 12pt; 
        color: #6b7280; 
        border-top: 1px solid #d1d5db;
        display: inline-block;
        padding-top: 20pt;
        min-width: 200pt;
      }
      
      /* ç›®å½•æ ·å¼ */
      .toc-box {
        background-color: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 8pt;
        padding: 20pt;
        margin-bottom: 40pt;
      }
      .toc-title {
        font-size: 16pt;
        font-weight: bold;
        margin-bottom: 12pt;
        text-align: center;
        color: #111827;
      }
      
      /* ç« èŠ‚æ’ç‰ˆ */
      h1 { 
        font-size: 20pt; 
        color: #2563eb; 
        margin-top: 24pt; 
        margin-bottom: 12pt; 
        font-weight: bold; 
        border-left: 5px solid #2563eb;
        padding-left: 10pt;
      }
      h2 { 
        font-size: 16pt; 
        color: #1d4ed8; 
        margin-top: 18pt; 
        margin-bottom: 10pt; 
        font-weight: bold; 
      }
      h3 { 
        font-size: 13pt; 
        color: #1e40af; 
        margin-top: 12pt; 
        margin-bottom: 8pt; 
        font-weight: bold; 
      }
      
      /* æ­£æ–‡ä¸å¼•ç”¨ */
      p { 
        margin-bottom: 10pt; 
        text-align: justify; 
      }
      
      blockquote { 
        border-left: 4px solid #2563eb; 
        padding: 10pt 15pt; 
        color: #4b5563; 
        font-style: italic; 
        margin: 15pt 0; 
        background: #f3f4f6; 
        border-radius: 0 4pt 4pt 0;
      }
      
      /* æç¤ºæ¡† (Callout) */
      .callout { 
        background-color: #eff6ff; 
        border: 1px solid #bfdbfe; 
        border-radius: 6pt; 
        padding: 12pt; 
        margin: 12pt 0; 
      }
      .callout-info { border-left: 4px solid #3b82f6; }
      .callout-warning { background-color: #fffbeb; border-color: #fcd34d; border-left: 4px solid #f59e0b; }
      
      .callout-title { 
        font-weight: bold; 
        color: #1e40af; 
        margin-bottom: 4pt; 
        display: block;
      }
      
      /* è¡¨æ ¼æ ·å¼ */
      table { 
        width: 100%; 
        border-collapse: collapse; 
        margin: 16pt 0; 
        box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
        font-size: 10pt;
      }
      th { 
        background-color: #f8fafc; 
        text-align: left; 
        padding: 10pt; 
        font-weight: bold; 
        border-bottom: 2px solid #e2e8f0; 
        color: #1f2937;
      }
      td { 
        padding: 10pt; 
        border-bottom: 1px solid #e2e8f0; 
        color: #4b5563;
      }
      tr:last-child td { border-bottom: none; }
      
      /* ä»£ç å—æ¨¡æ‹Ÿ */
      .code-block {
        font-family: 'Consolas', 'Monaco', monospace;
        background-color: #1f2937;
        color: #f3f4f6;
        padding: 12pt;
        border-radius: 6pt;
        margin: 12pt 0;
        white-space: pre-wrap;
        font-size: 9pt;
      }
    `,
  },
  systemPrompt: `è¯·æ’°å†™ä¸€ä»½ä¸“ä¸šçš„æŠ€æœ¯ç™½çš®ä¹¦ã€‚
è¦æ±‚ï¼š
1. åŒ…å«å°é¢é¡µï¼ˆ<div class="cover-page">...</div>ï¼‰ï¼Œå«æ ‡é¢˜ã€å‰¯æ ‡é¢˜ã€ç‰ˆæœ¬å·ã€ä½œè€…ã€‚
2. åŒ…å«ç›®å½•å ä½ç¬¦ã€‚
3. æ­£æ–‡åŒ…å«è‡³å°‘3ä¸ªä¸»è¦ç« èŠ‚ï¼ˆå¼•è¨€ã€æŠ€æœ¯æ¶æ„ã€è§£å†³æ–¹æ¡ˆï¼‰ã€‚
4. ä½¿ç”¨ <blockquote class="callout callout-info">...</blockquote> åˆ¶ä½œä¿¡æ¯æç¤ºæ¡†ã€‚
5. ä½¿ç”¨è¡¨æ ¼å±•ç¤ºæŠ€æœ¯å‚æ•°å¯¹æ¯”ã€‚
6. ä½¿ç”¨ä»£ç å—æ ·å¼å±•ç¤ºé…ç½®ç¤ºä¾‹ã€‚
7. ä¿æŒè¯­æ°”ä¸“ä¸šã€å®¢è§‚ã€‚`,
}


// --- START OF FILE: src/renderer/locales/en-US.ts ---
import type { LocaleResource } from './zh-CN'

export const enUS: LocaleResource = {
  common: {
    appName: 'WordSmith AI',
    appDesc: 'WordSmith AI - High-fidelity Word Typesetting Desktop App driven by AI',
    confirm: 'Confirm',
    cancel: 'Cancel',
    save: 'Save',
    delete: 'Delete',
    edit: 'Edit',
    copy: 'Copy',
    loading: 'Loading...',
    success: 'Success',
    error: 'Error',
    searchPlaceholder: 'Search...',
    noData: 'No Data',
  },
  nav: {
    new: 'New Design',
    history: 'History',
    templates: 'Templates',
    settings: 'Settings',
    workflow: 'AI â†’ HTML(Inline CSS) â†’ Clipboard â†’ Word',
  },
  chat: {
    title: 'AI Chat',
    generate: 'Generate',
    fix: 'Fix Format',
    placeholder: 'E.g. Write a financial report summary with tables and formula $E=mc^2$, output pure HTML.',
    placeholderFix: 'Fix Mode: Use current HTML as input to clean up formatting.',
    emptyTip: 'Enter requirements on the left, or switch to "Fix Format" to clean current HTML.',
    noApiKey: 'API Key not set. Cannot send request.',
    tokens: 'Tokens Used',
    generating: 'Generating...',
  },
  editor: {
    title: 'HTML Source',
    copy: 'Copy Source',
  },
  preview: {
    title: 'Live Preview',
    copyToWord: 'Copy to Word',
    guardReport: {
      units: 'Units Converted',
      tables: 'Tables Processed',
      styles: 'Style Tags Removed',
      links: 'External Links Removed',
      mathml: 'MathML Cleaned',
      body: 'Body Enforced',
      yes: 'Yes',
      no: 'No',
    },
  },
  macro: {
    title: 'VBA Assistant',
    copy: 'Copy VBA',
    desc: 'Copy this code to Word VBA Editor to batch convert $$...$$ to Word Math objects.',
    step1: 'Word: Developer Tab â†’ Visual Basic',
    step2: 'Insert Module â†’ Paste Code â†’ Run Macro',
    step3: 'Recommended to run after pasting HTML to Word',
  },
  settings: {
    title: 'Settings',
    modelConfig: 'Model Config',
    baseUrl: 'BaseURL',
    apiKey: 'API Key',
    model: 'Model Name',
    typography: 'Typography',
    fontFamily: 'Default Font',
    fontSize: 'Default Size (pt)',
    language: 'Language',
    theme: 'Theme',
    themeLight: 'Light',
    themeDark: 'Dark',
    themeSystem: 'System',
    about: 'About',
    version: 'Version',
  },
  history: {
    title: 'History',
    clear: 'Clear All',
    itemTitle: 'Result',
    reEdit: 'Re-Edit',
    viewSource: 'View Source',
    deleteConfirm: 'Are you sure you want to delete this item?',
    clearConfirm: 'Are you sure you want to clear all history? This cannot be undone.',
  },
  templates: {
    title: 'Templates',
    desc: 'Select or customize your typesetting style templates',
    default: 'Default',
    academic: 'Academic',
    financial: 'Financial',
    government: 'Government',
    current: 'Current',
    use: 'Use This',
    preview: 'Style Preview',
    css: 'Custom CSS',
  },
  errors: {
    network: 'Network connection failed',
    apiAuth: 'Invalid or expired API Key',
    apiQuota: 'API quota exceeded',
    parse: 'HTML parsing error',
    clipboard: 'Clipboard write failed',
    unknown: 'Unknown Error',
  },
}


// --- START OF FILE: src/renderer/locales/zh-CN.ts ---
export const zhCN = {
  common: {
    appName: 'WordSmith AI',
    appDesc: 'æ™ºæ’ç²¾çµ - AI é©±åŠ¨çš„ Word é«˜ä¿çœŸæ’ç‰ˆæ¡Œé¢åº”ç”¨',
    confirm: 'ç¡®è®¤',
    cancel: 'å–æ¶ˆ',
    save: 'ä¿å­˜',
    delete: 'åˆ é™¤',
    edit: 'ç¼–è¾‘',
    copy: 'å¤åˆ¶',
    loading: 'åŠ è½½ä¸­...',
    success: 'æ“ä½œæˆåŠŸ',
    error: 'å‘ç”Ÿé”™è¯¯',
    searchPlaceholder: 'æœç´¢...',
    noData: 'æš‚æ— æ•°æ®',
  },
  nav: {
    new: 'æ–°å»ºæ’ç‰ˆ',
    history: 'å†å²è®°å½•',
    templates: 'æ¨¡æ¿ç®¡ç†',
    settings: 'è®¾ç½®',
    workflow: 'AI â†’ HTML(Inline CSS) â†’ Clipboard â†’ Word',
  },
  chat: {
    title: 'AI å¯¹è¯',
    generate: 'ç”Ÿæˆ',
    fix: 'çº é”™',
    placeholder: 'ä¾‹å¦‚ï¼šå†™ä¸€ä»½é‡‘èç ”æŠ¥æ‘˜è¦ï¼ŒåŒ…å«è¡¨æ ¼ä¸å…¬å¼ $E=mc^2$ï¼Œä¸¥æ ¼è¾“å‡ºçº¯ HTMLã€‚',
    placeholderFix: 'çº é”™æ¨¡å¼ï¼šå°†ä½¿ç”¨å½“å‰ HTML ä½œä¸ºè¾“å…¥',
    emptyTip: 'åœ¨å·¦ä¾§è¾“å…¥éœ€æ±‚ï¼Œæˆ–åˆ‡æ¢åˆ°â€œçº é”™â€å°†å½“å‰ HTML æ¸…æ´—ä¸ºåè®®æ ¼å¼ã€‚',
    noApiKey: 'æœªè®¾ç½® API Keyï¼Œæ— æ³•å‘é€è¯·æ±‚ã€‚',
    tokens: 'æ¶ˆè€— Token',
    generating: 'æ­£åœ¨ç”Ÿæˆ...',
  },
  editor: {
    title: 'HTML æºç ',
    copy: 'å¤åˆ¶æºç ',
  },
  preview: {
    title: 'å®æ—¶é¢„è§ˆ',
    copyToWord: 'å¤åˆ¶åˆ° Word',
    guardReport: {
      units: 'å•ä½è½¬æ¢',
      tables: 'è¡¨æ ¼å¤„ç†',
      styles: 'ç§»é™¤ style æ ‡ç­¾',
      links: 'ç§»é™¤å¤–é“¾æ ·å¼',
      mathml: 'MathML æ¸…æ´—',
      body: 'Body ä¿®å¤',
      yes: 'æ˜¯',
      no: 'å¦',
    },
  },
  macro: {
    title: 'VBA åŠ©æ‰‹',
    copy: 'å¤åˆ¶ VBA',
    desc: 'å°†ä»£ç å¤åˆ¶åˆ° Word çš„ VBA ç¼–è¾‘å™¨ä¸­è¿è¡Œï¼Œå¯å°† $$...$$ å…¬å¼æ‰¹é‡è½¬æ¢ä¸º Word å…¬å¼å¯¹è±¡ã€‚',
    step1: 'Wordï¼šå¼€å‘å·¥å…· â†’ Visual Basic',
    step2: 'æ’å…¥æ¨¡å— â†’ ç²˜è´´ä»£ç  â†’ è¿è¡Œå®',
    step3: 'å»ºè®®åœ¨å¤åˆ¶ HTML åˆ° Word ä¹‹åå†è¿è¡Œ',
  },
  settings: {
    title: 'è®¾ç½®',
    modelConfig: 'æ¨¡å‹é…ç½®',
    baseUrl: 'BaseURL',
    apiKey: 'API Key',
    model: 'æ¨¡å‹åç§°',
    typography: 'æ’ç‰ˆè®¾ç½®',
    fontFamily: 'é»˜è®¤å­—ä½“',
    fontSize: 'é»˜è®¤å­—å· (pt)',
    language: 'ç•Œé¢è¯­è¨€',
    theme: 'ä¸»é¢˜è®¾ç½®',
    themeLight: 'æµ…è‰²æ¨¡å¼',
    themeDark: 'æ·±è‰²æ¨¡å¼',
    themeSystem: 'è·Ÿéšç³»ç»Ÿ',
    about: 'å…³äºæˆ‘ä»¬',
    version: 'å½“å‰ç‰ˆæœ¬',
  },
  history: {
    title: 'å†å²è®°å½•',
    clear: 'æ¸…ç©ºå†å²',
    itemTitle: 'æ’ç‰ˆç»“æœ',
    reEdit: 'é‡æ–°ç¼–è¾‘',
    viewSource: 'æŸ¥çœ‹æºç ',
    deleteConfirm: 'ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ',
    clearConfirm: 'ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚',
  },
  templates: {
    title: 'æ¨¡æ¿ç®¡ç†',
    desc: 'é€‰æ‹©æˆ–è‡ªå®šä¹‰æ‚¨çš„æ’ç‰ˆé£æ ¼æ¨¡æ¿',
    default: 'é»˜è®¤æ¨¡æ¿',
    academic: 'å­¦æœ¯è®ºæ–‡',
    financial: 'é‡‘èç ”æŠ¥',
    government: 'å…¬æ–‡çº¢å¤´',
    current: 'å½“å‰ä½¿ç”¨',
    use: 'ä½¿ç”¨æ­¤æ¨¡æ¿',
    preview: 'æ ·å¼é¢„è§ˆ',
    css: 'è‡ªå®šä¹‰ CSS',
  },
  errors: {
    network: 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®',
    apiAuth: 'API Key æ— æ•ˆæˆ–è¿‡æœŸ',
    apiQuota: 'API é¢åº¦å·²è€—å°½',
    parse: 'HTML è§£æé”™è¯¯',
    clipboard: 'å‰ªè´´æ¿å†™å…¥å¤±è´¥',
    unknown: 'æœªçŸ¥é”™è¯¯',
  },
}

export type LocaleResource = typeof zhCN


// --- START OF FILE: src/renderer/main.tsx ---
import React from 'react'
import ReactDOM from 'react-dom/client'
import { HashRouter } from 'react-router-dom'
import App from './App.tsx'
import { Toaster } from './components/ui/Toaster'
import './index.css'

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <HashRouter>
      <App />
      <Toaster />
    </HashRouter>
  </React.StrictMode>,
)


// --- START OF FILE: src/renderer/pages/Help.tsx ---
import { useState } from 'react'
import { Book, Code, HelpCircle, Settings } from 'lucide-react'
import { PageLayout } from '../layouts/PageLayout'
import { cn } from '../lib/cn'
import { ApiGuide } from '../components/help/ApiGuide'
import { VbaGuide } from '../components/help/VbaGuide'
import { TheoryGuide } from '../components/help/TheoryGuide'
import { FaqList } from '../components/help/FaqList'

const TABS = [
  { id: 'api', label: 'API é…ç½®', icon: Settings, component: ApiGuide },
  { id: 'vba', label: 'VBA å®æŒ‡å—', icon: Code, component: VbaGuide },
  { id: 'theory', label: 'æ’ç‰ˆåŸç†', icon: Book, component: TheoryGuide },
  { id: 'faq', label: 'å¸¸è§é—®é¢˜', icon: HelpCircle, component: FaqList },
]

export default function HelpPage() {
  const [activeTab, setActiveTab] = useState('api')
  const ActiveComponent = TABS.find((t) => t.id === activeTab)?.component || ApiGuide

  return (
    <PageLayout>
      <div className="mx-auto flex w-full max-w-[1024px] gap-6">
        {/* Side Menu */}
        <div className="w-64 shrink-0 space-y-1">
          <div className="mb-4 px-3 text-lg font-semibold">å¸®åŠ©ä¸­å¿ƒ</div>
          {TABS.map((tab) => {
            const Icon = tab.icon
            return (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id)}
                className={cn(
                  'flex w-full items-center gap-2 rounded-lg px-3 py-2 text-sm font-medium transition-colors',
                  activeTab === tab.id
                    ? 'bg-blue-50 text-blue-600 dark:bg-blue-900/20 dark:text-blue-400'
                    : 'text-slate-600 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-800',
                )}
              >
                <Icon size={18} />
                {tab.label}
              </button>
            )
          })}
        </div>

        {/* Content Area */}
        <div className="min-w-0 flex-1">
          <ActiveComponent />
        </div>
      </div>
    </PageLayout>
  )
}


// --- START OF FILE: src/renderer/pages/History.tsx ---
import { useState } from 'react'
import { Trash2 } from 'lucide-react'
import { CopyToWordButton } from '../components/business/CopyToWordButton'
import { Button } from '../components/ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '../components/ui/card'
import { Input } from '../components/ui/input'
import { PageLayout } from '../layouts/PageLayout'
import { useAppStore } from '../store/useAppStore'
import { useI18n } from '../store/useI18nStore'

export default function HistoryPage() {
  const t = useI18n()
  const history = useAppStore((s) => s.history)
  const clearHistory = useAppStore((s) => s.clearHistory)
  const deleteHistoryItem = useAppStore((s) => s.deleteHistoryItem)
  const [search, setSearch] = useState('')

  const filtered = history.filter((item) => {
    if (!search) return true
    return item.title.toLowerCase().includes(search.toLowerCase()) || item.finalHtml.includes(search)
  })

  return (
    <PageLayout>
      <div className="mx-auto flex w-full max-w-[920px] flex-col gap-4">
        <div className="flex items-end justify-between gap-3">
          <div>
            <div className="text-sm font-semibold">{t.history.title}</div>
            <div className="mt-1 text-xs text-slate-600 dark:text-slate-400">
              {t.common.appDesc}
            </div>
          </div>
          <Button variant="secondary" onClick={() => {
            if (confirm(t.history.clearConfirm)) clearHistory()
          }} disabled={history.length === 0}>
            {t.history.clear}
          </Button>
        </div>

        <div className="flex items-center gap-2">
          <Input 
            value={search} 
            onChange={(e) => setSearch(e.target.value)} 
            placeholder={t.common.searchPlaceholder}
            className="max-w-[300px]"
          />
        </div>

        {filtered.length === 0 ? (
          <div className="rounded-lg border border-slate-200 bg-white p-4 text-xs text-slate-600 dark:border-slate-800 dark:bg-slate-950 dark:text-slate-400">
            {t.common.noData}
          </div>
        ) : (
          <div className="space-y-3">
            {filtered.map((item) => (
              <Card key={item.id}>
                <CardHeader>
                  <div className="flex items-center justify-between gap-3">
                    <CardTitle className="truncate">{item.title}</CardTitle>
                    <div className="flex items-center gap-2">
                      <div className="text-xs text-slate-500 dark:text-slate-400">{new Date(item.createdAt).toLocaleString()}</div>
                      <Button variant="ghost" size="sm" className="h-6 w-6 p-0 text-slate-400 hover:text-rose-500" onClick={() => {
                        if (confirm(t.history.deleteConfirm)) deleteHistoryItem(item.id)
                      }}>
                        <Trash2 size={14} />
                      </Button>
                    </div>
                  </div>
                </CardHeader>
                <CardContent className="space-y-3">
                  <div className="grid grid-cols-1 gap-2">
                    <CopyToWordButton html={item.finalHtml} />
                    <details className="rounded-lg border border-slate-200 bg-slate-50 p-3 text-xs text-slate-700 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200">
                      <summary className="cursor-pointer select-none">{t.history.viewSource}</summary>
                      <pre className="mt-2 max-h-[240px] overflow-auto whitespace-pre-wrap">{item.finalHtml}</pre>
                    </details>
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>
        )}
      </div>
    </PageLayout>
  )
}


// --- START OF FILE: src/renderer/pages/New.tsx ---
import { useEffect, useMemo, useState } from 'react'
import type { GuardReport } from '../types/guard'
import { guardHtml } from '../lib/protocol-guard'
import { getTemplateById } from '../lib/templates'
import { ChatPanel } from '../components/business/ChatPanel'
import { CopyToWordButton } from '../components/business/CopyToWordButton'
import { HtmlEditor } from '../components/business/HtmlEditor'
import { MacroGenerator } from '../components/business/MacroGenerator'
import { PreviewFrame } from '../components/business/PreviewFrame'
import { Sidebar } from '../components/business/Sidebar'
import { Card, CardContent, CardHeader, CardTitle } from '../components/ui/card'
import { Input } from '../components/ui/input'
import { useAppStore } from '../store/useAppStore'
import { useI18n } from '../store/useI18nStore'

const DEFAULT_HTML = `<body style="margin:0; padding:0; font-family:'SimSun'; font-size:12pt;">
  <p style="margin:0 0 12pt 0;">å°† AI ç”Ÿæˆçš„å†…å®¹ç²˜è´´åˆ°è¿™é‡Œï¼Œå³ä¾§é¢„è§ˆä¸å¤åˆ¶ä¼šè‡ªåŠ¨ä½¿ç”¨æ’ç‰ˆåè®®å®ˆå«ã€‚</p>
  <table style="width:600px; border:1px solid #333;">
    <tr>
      <td style="padding:8px;">ç¤ºä¾‹</td>
      <td style="padding:8px;">$E=mc^2$</td>
    </tr>
  </table>
</body>`

export default function NewPage() {
  const t = useI18n()
  const settings = useAppStore((s) => s.settings)
  const updateTypography = useAppStore((s) => s.updateTypography)
  const presets = useAppStore((s) => s.presets)
  const addHistoryItem = useAppStore((s) => s.addHistoryItem)
  const selectedPreset = presets[0]

  const template = useMemo(() => getTemplateById(settings.templateId), [settings.templateId])

  const [htmlDraft, setHtmlDraft] = useState(DEFAULT_HTML)
  const [finalHtml, setFinalHtml] = useState(DEFAULT_HTML)
  const [guardReport, setGuardReport] = useState<GuardReport | null>(null)

  // Merge template styles with settings (Settings take priority if modified, or just use template as base)
  // Here we use settings.typography as the source of truth for the ChatPanel generation parameters,
  // but for the visual guard/preview, we might want to ensure the template CSS is respected.
  // Actually, guardHtml uses `defaults` to inject styles if missing.
  
  const activeTypography = useMemo(() => ({
    fontFamily: settings.typography.fontFamily || template.style.fontFamily,
    fontSizePt: settings.typography.fontSizePt || template.style.fontSizePt,
  }), [settings.typography, template])

  const guarded = useMemo(() => guardHtml(htmlDraft, activeTypography), [htmlDraft, activeTypography])

  useEffect(() => {
    setFinalHtml(guarded.html)
    setGuardReport(guarded.report)
  }, [guarded])

  return (
    <div className="h-full w-full bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100">
      <div className="flex h-full">
        <Sidebar />

        <main className="flex h-full min-w-0 flex-1 gap-3 p-3">
          {/* ä¸­é—´ä¸»è¦åŒºåŸŸï¼šå¯¹è¯ + ç¼–è¾‘ */}
          <section className="flex min-w-0 flex-1 flex-col gap-3">
            <div className="flex-1 overflow-hidden rounded-xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-800 dark:bg-slate-950">
              <ChatPanel
                baseUrl={settings.ai.baseUrl}
                apiKey={settings.ai.apiKey}
                model={settings.ai.model}
                defaults={activeTypography}
                presetPrompt={template.systemPrompt || selectedPreset?.userPrompt}
                htmlDraft={htmlDraft}
                onHtmlFinalized={(html, report, payload) => {
                  setHtmlDraft(html)
                  setFinalHtml(html)
                  setGuardReport(report)
                  const title = payload.messages.find((m) => m.role === 'user')?.content?.slice(0, 24) || t.history.itemTitle
                  addHistoryItem({
                    title,
                    mode: payload.mode,
                    messages: payload.messages,
                    finalHtml: html,
                  })
                }}
              />
            </div>
            <div className="h-[300px] shrink-0 overflow-hidden rounded-xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-800 dark:bg-slate-950">
              <HtmlEditor value={htmlDraft} onChange={setHtmlDraft} />
            </div>
          </section>

          {/* å³ä¾§é…ç½®ä¸é¢„è§ˆ */}
          <section className="flex w-[400px] shrink-0 flex-col gap-3 overflow-y-auto pb-2">
            <Card>
              <CardHeader className="py-3">
                <CardTitle className="text-sm">æ’ç‰ˆå‚æ•°</CardTitle>
              </CardHeader>
              <CardContent className="grid grid-cols-2 gap-2 py-0 pb-3">
                <Input value={settings.typography.fontFamily} onChange={(e) => updateTypography({ fontFamily: e.target.value })} placeholder={t.settings.fontFamily} />
                <Input
                  value={String(settings.typography.fontSizePt)}
                  onChange={(e) => updateTypography({ fontSizePt: Number(e.target.value) || 12 })}
                  placeholder={t.settings.fontSize}
                  inputMode="numeric"
                />
              </CardContent>
            </Card>

            <div className="flex h-[400px] shrink-0 flex-col rounded-xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-800 dark:bg-slate-950">
              <PreviewFrame html={finalHtml} />
            </div>

            <div className="grid grid-cols-1 gap-2">
              <CopyToWordButton html={finalHtml} />
              {guardReport ? (
                <div className="rounded-lg border border-slate-200 bg-white p-3 text-xs text-slate-600 dark:border-slate-800 dark:bg-slate-950 dark:text-slate-300">
                  <div className="grid grid-cols-2 gap-2">
                    <div>{t.preview.guardReport.units}ï¼š{guardReport.convertedUnits}</div>
                    <div>{t.preview.guardReport.tables}ï¼š{guardReport.tablesProcessed}</div>
                    <div>{t.preview.guardReport.styles}ï¼š{guardReport.removedStyleTags}</div>
                    <div>{t.preview.guardReport.links}ï¼š{guardReport.removedStylesheetLinks}</div>
                    <div>{t.preview.guardReport.mathml}ï¼š{guardReport.mathMlNodesRemoved}</div>
                    <div>{t.preview.guardReport.body}ï¼š{guardReport.enforcedBodyStyle ? t.preview.guardReport.yes : t.preview.guardReport.no}</div>
                  </div>
                </div>
              ) : null}
            </div>

            <MacroGenerator />
          </section>
        </main>
      </div>
    </div>
  )
}


// --- START OF FILE: src/renderer/pages/Settings.tsx ---
import { useState } from 'react'
import { PageLayout } from '../layouts/PageLayout'
import { Button } from '../components/ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '../components/ui/card'
import { Input } from '../components/ui/input'
import { useAppStore } from '../store/useAppStore'
import { useI18n, useLocale, useSetLocale } from '../store/useI18nStore'
import { settingsService } from '../services/SettingsService'
import { toast } from '../store/useToastStore'
import { cn } from '../lib/cn'

const TABS = [
  { id: 'general', label: 'å¸¸è§„' },
  { id: 'appearance', label: 'å¤–è§‚' },
  { id: 'ai', label: 'AI æ¨¡å‹' },
  { id: 'advanced', label: 'é«˜çº§' },
]

export default function SettingsPage() {
  const t = useI18n()
  const locale = useLocale()
  const setLocale = useSetLocale()
  
  const settings = useAppStore((s) => s.settings)
  const setTheme = useAppStore((s) => s.setTheme)
  const updateAi = useAppStore((s) => s.updateAi)
  const updateTypography = useAppStore((s) => s.updateTypography)
  const updateSettings = useAppStore((s) => s.updateSettings)

  const [activeTab, setActiveTab] = useState('general')

  const handleReset = () => {
    if (confirm('ç¡®å®šè¦æ¢å¤å‡ºå‚è®¾ç½®å—ï¼Ÿè¿™å°†ä¸¢å¤±æ‰€æœ‰è‡ªå®šä¹‰é…ç½®ã€‚')) {
      settingsService.resetToDefaults()
      toast({ title: 'å·²æ¢å¤å‡ºå‚è®¾ç½®', variant: 'success' })
    }
  }

  const handleExport = () => {
    const json = settingsService.exportSettings()
    const blob = new Blob([json], { type: 'application/json' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = `wordsmith-settings-${Date.now()}.json`
    a.click()
    toast({ title: 'é…ç½®å·²å¯¼å‡º', variant: 'success' })
  }

  return (
    <PageLayout>
      <div className="mx-auto flex w-full max-w-[920px] flex-col gap-4">
        <div>
          <div className="text-sm font-semibold">{t.settings.title}</div>
          <div className="mt-1 text-xs text-slate-600 dark:text-slate-400">{t.common.appDesc}</div>
        </div>

        {/* Tabs */}
        <div className="flex gap-2 border-b border-slate-200 dark:border-slate-800">
          {TABS.map((tab) => (
            <button
              key={tab.id}
              onClick={() => setActiveTab(tab.id)}
              className={cn(
                'border-b-2 px-4 py-2 text-sm font-medium transition-colors',
                activeTab === tab.id
                  ? 'border-blue-500 text-blue-600 dark:border-blue-400 dark:text-blue-400'
                  : 'border-transparent text-slate-600 hover:text-slate-900 dark:text-slate-400 dark:hover:text-slate-200',
              )}
            >
              {tab.label}
            </button>
          ))}
        </div>

        <div className="space-y-4">
          {/* å¸¸è§„è®¾ç½® */}
          {activeTab === 'general' && (
            <Card>
              <CardHeader>
                <CardTitle>{t.settings.language}</CardTitle>
              </CardHeader>
              <CardContent className="flex gap-2">
                <Button variant={locale === 'zh-CN' ? 'default' : 'secondary'} onClick={() => setLocale('zh-CN')}>
                  ç®€ä½“ä¸­æ–‡
                </Button>
                <Button variant={locale === 'en-US' ? 'default' : 'secondary'} onClick={() => setLocale('en-US')}>
                  English
                </Button>
              </CardContent>
            </Card>
          )}

          {/* å¤–è§‚è®¾ç½® */}
          {activeTab === 'appearance' && (
            <>
              <Card>
                <CardHeader>
                  <CardTitle>{t.settings.theme}</CardTitle>
                </CardHeader>
                <CardContent className="flex gap-2">
                  <Button variant={settings.theme === 'system' ? 'default' : 'secondary'} onClick={() => setTheme('system')}>
                    {t.settings.themeSystem}
                  </Button>
                  <Button variant={settings.theme === 'light' ? 'default' : 'secondary'} onClick={() => setTheme('light')}>
                    {t.settings.themeLight}
                  </Button>
                  <Button variant={settings.theme === 'dark' ? 'default' : 'secondary'} onClick={() => setTheme('dark')}>
                    {t.settings.themeDark}
                  </Button>
                </CardContent>
              </Card>

              <Card>
                <CardHeader>
                  <CardTitle>{t.settings.typography}</CardTitle>
                </CardHeader>
                <CardContent className="grid grid-cols-2 gap-2">
                  <Input
                    value={settings.typography.fontFamily}
                    onChange={(e) => updateTypography({ fontFamily: e.target.value })}
                    placeholder={t.settings.fontFamily}
                  />
                  <Input
                    value={String(settings.typography.fontSizePt)}
                    onChange={(e) => updateTypography({ fontSizePt: Number(e.target.value) || 12 })}
                    placeholder={t.settings.fontSize}
                    inputMode="numeric"
                  />
                </CardContent>
              </Card>

              <Card>
                <CardHeader>
                  <CardTitle>æ˜¾ç¤ºè®¾ç½®</CardTitle>
                </CardHeader>
                <CardContent className="flex items-center justify-between">
                  <span className="text-sm">æŠ¤çœ¼æ¨¡å¼ï¼ˆé™ä½å¯¹æ¯”åº¦ï¼‰</span>
                  <Button
                    variant={settings.eyeCareMode ? 'default' : 'secondary'}
                    onClick={() => updateSettings({ eyeCareMode: !settings.eyeCareMode })}
                    size="sm"
                  >
                    {settings.eyeCareMode ? 'å·²å¼€å¯' : 'å·²å…³é—­'}
                  </Button>
                </CardContent>
              </Card>
            </>
          )}

          {/* AI æ¨¡å‹è®¾ç½® */}
          {activeTab === 'ai' && (
            <Card>
              <CardHeader>
                <CardTitle>{t.settings.modelConfig}</CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="space-y-2">
                  <label className="text-xs font-medium text-slate-500">API æä¾›å•†</label>
                  <select
                    className="flex h-10 w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm ring-offset-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-950 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 dark:border-slate-800 dark:bg-slate-950 dark:ring-offset-slate-950 dark:focus-visible:ring-slate-300"
                    onChange={(e) => {
                      const url = e.target.value
                      if (url) updateAi({ baseUrl: url })
                    }}
                    value={
                      [
                        'https://api.deepseek.com',
                        'https://api-inference.modelscope.cn/v1',
                        'https://api.siliconflow.cn',
                        'https://open.bigmodel.cn/api/paas/v4',
                        'https://api.moonshot.cn',
                        'https://ark.cn-beijing.volces.com/api/v3',
                        'https://api.minimax.chat/v1',
                      ].includes(settings.ai.baseUrl)
                        ? settings.ai.baseUrl
                        : 'custom'
                    }
                  >
                    <option value="https://api.deepseek.com">DeepSeek</option>
                    <option value="https://api-inference.modelscope.cn/v1">ModelScope (é­”æ­)</option>
                    <option value="https://api.siliconflow.cn">SiliconFlow (ç¡…åŸºæµåŠ¨)</option>
                    <option value="https://open.bigmodel.cn/api/paas/v4">Zhipu (æ™ºè°±æ¸…è¨€)</option>
                    <option value="https://api.moonshot.cn">Moonshot (æœˆä¹‹æš—é¢)</option>
                    <option value="https://ark.cn-beijing.volces.com/api/v3">ByteDance (å­—èŠ‚è·³åŠ¨/ç«å±±)</option>
                    <option value="https://api.minimax.chat/v1">Minimax</option>
                    <option value="custom">Custom (è‡ªå®šä¹‰)</option>
                  </select>
                </div>

                <div className="space-y-2">
                  <label className="text-xs font-medium text-slate-500">Base URL</label>
                  <Input
                    value={settings.ai.baseUrl}
                    onChange={(e) => updateAi({ baseUrl: e.target.value })}
                    placeholder={t.settings.baseUrl}
                  />
                </div>

                <div className="space-y-2">
                  <label className="text-xs font-medium text-slate-500">æ¨¡å‹åç§° (Model)</label>
                  <Input
                    value={settings.ai.model}
                    onChange={(e) => updateAi({ model: e.target.value })}
                    placeholder={t.settings.model}
                  />
                  <div className="text-xs text-slate-400">
                    ä¾‹å¦‚: deepseek-chat, qwen-max, moonshot-v1-8k
                  </div>
                </div>

                <div className="space-y-2">
                  <label className="text-xs font-medium text-slate-500">API Key</label>
                  <Input
                    value={settings.ai.apiKey}
                    onChange={(e) => updateAi({ apiKey: e.target.value })}
                    placeholder={t.settings.apiKey}
                    type="password"
                  />
                </div>
              </CardContent>
            </Card>
          )}

          {/* é«˜çº§è®¾ç½® */}
          {activeTab === 'advanced' && (
            <Card>
              <CardHeader>
                <CardTitle>ç³»ç»Ÿå‚æ•°</CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="space-y-2">
                  <label className="text-xs font-medium text-slate-500">API è¯·æ±‚è¶…æ—¶ (ms)</label>
                  <Input
                    value={String(settings.timeout)}
                    onChange={(e) => {
                      const val = Number(e.target.value)
                      if (!isNaN(val)) updateSettings({ timeout: val })
                    }}
                    type="number"
                  />
                </div>

                <div className="space-y-2">
                  <label className="text-xs font-medium text-slate-500">é»˜è®¤ä¿å­˜è·¯å¾„</label>
                  <Input
                    value={settings.savePath}
                    onChange={(e) => updateSettings({ savePath: e.target.value })}
                  />
                </div>

                <div className="flex gap-2 pt-4">
                  <Button variant="secondary" onClick={handleExport} className="w-full">
                    å¯¼å‡ºé…ç½®
                  </Button>
                  <Button variant="destructive" onClick={handleReset} className="w-full">
                    æ¢å¤å‡ºå‚è®¾ç½®
                  </Button>
                </div>
              </CardContent>
            </Card>
          )}
        </div>
      </div>
    </PageLayout>
  )
}


// --- START OF FILE: src/renderer/pages/Templates.tsx ---
import { useMemo, useState } from 'react'
import type { PromptMode } from '../types/ai'
import { templates } from '../lib/templates'
import { Button } from '../components/ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '../components/ui/card'
import { Input } from '../components/ui/input'
import { Textarea } from '../components/ui/textarea'
import { PageLayout } from '../layouts/PageLayout'
import { useAppStore } from '../store/useAppStore'
import { useI18n } from '../store/useI18nStore'

export default function TemplatesPage() {
  const t = useI18n()
  const settings = useAppStore((s) => s.settings)
  const setTemplateId = useAppStore((s) => s.setTemplateId)
  const presets = useAppStore((s) => s.presets)
  const addPreset = useAppStore((s) => s.addPreset)
  const updatePreset = useAppStore((s) => s.updatePreset)
  const removePreset = useAppStore((s) => s.removePreset)

  const [name, setName] = useState('æ–°é¢„è®¾')
  const [mode, setMode] = useState<PromptMode>('generate')
  const [userPrompt, setUserPrompt] = useState('ä¸¥æ ¼éµå¾ªæ’ç‰ˆåè®®è¾“å‡ºçº¯ HTMLã€‚')

  const canAdd = useMemo(() => name.trim().length > 0 && userPrompt.trim().length > 0, [name, userPrompt])

  return (
    <PageLayout>
      <div className="mx-auto flex w-full max-w-[920px] flex-col gap-4">
        <div>
          <div className="text-sm font-semibold">{t.templates.title}</div>
          <div className="mt-1 text-xs text-slate-600 dark:text-slate-400">{t.templates.desc}</div>
        </div>

        {/* æ¨¡æ¿é€‰æ‹©åŒºåŸŸ */}
        <div className="grid grid-cols-2 gap-3 sm:grid-cols-4">
          {templates.map((tpl) => {
            const isActive = settings.templateId === tpl.id
            return (
              <div
                key={tpl.id}
                onClick={() => setTemplateId(tpl.id)}
                className={`cursor-pointer rounded-xl border p-4 transition-all ${
                  isActive
                    ? 'border-blue-500 bg-blue-50 ring-2 ring-blue-500/20 dark:bg-blue-900/20'
                    : 'border-slate-200 bg-white hover:border-blue-300 dark:border-slate-800 dark:bg-slate-950'
                }`}
              >
                <div className="font-semibold text-slate-900 dark:text-slate-100">
                  {/* @ts-ignore dynamic key access */}
                  {t.templates[tpl.id] || tpl.id}
                </div>
                <div className="mt-1 text-xs text-slate-500 dark:text-slate-400">
                  {isActive ? t.templates.current : t.templates.use}
                </div>
              </div>
            )
          })}
        </div>

        {/* é¢„è®¾ç®¡ç† (ä¿ç•™åŸæœ‰é€»è¾‘) */}
        <div className="my-4 border-t border-slate-200 dark:border-slate-800" />
        
        <Card>
          <CardHeader>
            <CardTitle>æ–°å¢æç¤ºè¯é¢„è®¾</CardTitle>
          </CardHeader>
          <CardContent className="space-y-2">
            <div className="grid grid-cols-3 gap-2">
              <div className="col-span-2">
                <Input value={name} onChange={(e) => setName(e.target.value)} placeholder="é¢„è®¾åç§°" />
              </div>
              <div className="flex gap-2">
                <Button variant={mode === 'generate' ? 'default' : 'secondary'} onClick={() => setMode('generate')} className="w-full">
                  {t.chat.generate}
                </Button>
                <Button variant={mode === 'fix' ? 'default' : 'secondary'} onClick={() => setMode('fix')} className="w-full">
                  {t.chat.fix}
                </Button>
              </div>
            </div>
            <Textarea value={userPrompt} onChange={(e) => setUserPrompt(e.target.value)} placeholder="æç¤ºè¯å†…å®¹" />
            <Button
              onClick={() => {
                addPreset({ name: name.trim(), mode, userPrompt: userPrompt.trim() })
              }}
              disabled={!canAdd}
            >
              æ·»åŠ 
            </Button>
          </CardContent>
        </Card>

        <div className="space-y-3">
          {presets.map((p) => (
            <Card key={p.id}>
              <CardHeader>
                <div className="flex items-center justify-between gap-3">
                  <CardTitle className="truncate">{p.name}</CardTitle>
                  <Button variant="destructive" size="sm" onClick={() => removePreset(p.id)} disabled={presets.length <= 1}>
                    {t.common.delete}
                  </Button>
                </div>
              </CardHeader>
              <CardContent className="space-y-2">
                <div className="grid grid-cols-3 gap-2">
                  <div className="col-span-2">
                    <Input value={p.name} onChange={(e) => updatePreset(p.id, { name: e.target.value })} />
                  </div>
                  <div className="flex gap-2">
                    <Button
                      size="sm"
                      variant={p.mode === 'generate' ? 'default' : 'secondary'}
                      onClick={() => updatePreset(p.id, { mode: 'generate' })}
                      className="w-full"
                    >
                      {t.chat.generate}
                    </Button>
                    <Button size="sm" variant={p.mode === 'fix' ? 'default' : 'secondary'} onClick={() => updatePreset(p.id, { mode: 'fix' })} className="w-full">
                      {t.chat.fix}
                    </Button>
                  </div>
                </div>
                <Textarea value={p.userPrompt} onChange={(e) => updatePreset(p.id, { userPrompt: e.target.value })} />
              </CardContent>
            </Card>
          ))}
        </div>
      </div>
    </PageLayout>
  )
}


// --- START OF FILE: src/renderer/services/ai-service.ts ---
import type { ChatMessage, StreamChatRequest } from '../types/ai'
import { buildSystemPrompt } from '../lib/system-prompts'

interface ChatCompletionChunk {
  choices?: Array<{
    delta?: {
      content?: string
    }
  }>
}

function normalizeBaseUrl(baseUrl: string): string {
  return baseUrl.replace(/\/+$/, '')
}

function buildInjectedMessages(request: StreamChatRequest): ChatMessage[] {
  const injected: ChatMessage = {
    role: 'system',
    content: buildSystemPrompt(request.mode, request.defaults),
  }
  return [injected, ...request.messages]
}

function parseSseLines(buffer: string): { events: string[]; rest: string } {
  const parts = buffer.split('\n')
  const events: string[] = []
  let current: string[] = []

  for (let i = 0; i < parts.length; i += 1) {
    const line = parts[i]
    if (line === undefined) continue

    if (line.trim() === '') {
      if (current.length) events.push(current.join('\n'))
      current = []
      continue
    }

    current.push(line)
  }

  const rest = current.length ? current.join('\n') : ''
  return { events, rest }
}

function extractDataLines(eventBlock: string): string[] {
  return eventBlock
    .split('\n')
    .map((l) => l.trimEnd())
    .filter((l) => l.startsWith('data:'))
    .map((l) => l.slice('data:'.length).trimStart())
}

export async function* streamChat(request: StreamChatRequest): AsyncGenerator<string> {
  const baseUrl = normalizeBaseUrl(request.model.baseUrl)
  const url = `${baseUrl}/v1/chat/completions`

  const res = await fetch(url, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      Authorization: `Bearer ${request.model.apiKey}`,
    },
    body: JSON.stringify({
      model: request.model.model,
      stream: true,
      messages: buildInjectedMessages(request),
    }),
    signal: request.signal,
  })

  if (!res.ok) {
    const text = await res.text().catch(() => '')
    throw new Error(`AI request failed: ${res.status} ${res.statusText}${text ? ` - ${text}` : ''}`)
  }

  if (!res.body) throw new Error('AI stream body is empty')

  const reader = res.body.getReader()
  const decoder = new TextDecoder('utf-8')

  let sseBuffer = ''

  while (true) {
    const { value, done } = await reader.read()
    if (done) break
    if (!value) continue

    sseBuffer += decoder.decode(value, { stream: true })
    const { events, rest } = parseSseLines(sseBuffer)
    sseBuffer = rest

    for (const eventBlock of events) {
      const dataLines = extractDataLines(eventBlock)
      for (const raw of dataLines) {
        if (raw === '[DONE]') return

        let json: ChatCompletionChunk
        try {
          json = JSON.parse(raw) as ChatCompletionChunk
        } catch {
          continue
        }

        const delta = json?.choices?.[0]?.delta?.content
        if (typeof delta === 'string' && delta.length) {
          yield delta
        }
      }
    }
  }
}


// --- START OF FILE: src/renderer/services/ErrorHandler.ts ---
import { logger } from './LoggerService'
import { toast } from '../store/useToastStore'

export type ErrorType = 'network' | 'api' | 'parse' | 'system' | 'validation'

class ErrorHandler {
  handle(error: unknown, type: ErrorType = 'system', userMessage?: string) {
    const message = error instanceof Error ? error.message : String(error)
    
    // Log internal error details
    logger.error('ErrorHandler', `[${type}] ${message}`, { error })

    // Determine user-facing message
    let title = 'å‘ç”Ÿé”™è¯¯'
    let description = userMessage || message

    switch (type) {
      case 'network':
        title = 'ç½‘ç»œè¿æ¥å¤±è´¥'
        if (!userMessage) description = 'è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè®¾ç½®æˆ–ä»£ç†é…ç½®ã€‚'
        break
      case 'api':
        title = 'AI æœåŠ¡è¯·æ±‚å¤±è´¥'
        if (message.includes('401')) description = 'API Key æ— æ•ˆæˆ–å·²è¿‡æœŸï¼Œè¯·åœ¨è®¾ç½®ä¸­æ£€æŸ¥ã€‚'
        else if (message.includes('429')) description = 'API è°ƒç”¨æ¬¡æ•°è¶…é™ï¼Œè¯·æ£€æŸ¥é¢åº¦ã€‚'
        break
      case 'parse':
        title = 'å†…å®¹è§£æå¼‚å¸¸'
        description = 'æ— æ³•è§£æ AI è¿”å›çš„å†…å®¹ï¼Œå»ºè®®é‡è¯•æˆ–åˆ‡æ¢æ¨¡å‹ã€‚'
        break
      case 'validation':
        title = 'å‚æ•°æ ¡éªŒå¤±è´¥'
        break
    }

    // Show UI notification
    toast({
      title,
      description,
      variant: 'destructive',
      duration: 5000,
    })
  }

  // Helper for async functions
  async wrap<T>(promise: Promise<T>, type: ErrorType = 'system', userMessage?: string): Promise<T | null> {
    try {
      return await promise
    } catch (error) {
      this.handle(error, type, userMessage)
      return null
    }
  }
}

export const errorHandler = new ErrorHandler()


// --- START OF FILE: src/renderer/services/LoggerService.ts ---
import { create } from 'zustand'
import { persist } from 'zustand/middleware'

export type LogLevel = 'info' | 'warn' | 'error' | 'action'

export interface LogEntry {
  id: string
  timestamp: number
  level: LogLevel
  module: string
  message: string
  meta?: any
}

interface LoggerState {
  logs: LogEntry[]
  addLog: (level: LogLevel, module: string, message: string, meta?: any) => void
  clearLogs: () => void
  exportLogs: () => string
}

export const useLoggerStore = create<LoggerState>()(
  persist(
    (set, get) => ({
      logs: [],
      addLog: (level, module, message, meta) => {
        const entry: LogEntry = {
          id: Math.random().toString(36).slice(2, 11),
          timestamp: Date.now(),
          level,
          module,
          message,
          meta,
        }
        // Keep logs in memory (max 1000)
        set((state) => ({
          logs: [entry, ...state.logs].slice(0, 1000),
        }))
        
        // Also print to console for dev
        const style = level === 'error' ? 'color: red' : level === 'warn' ? 'color: orange' : 'color: blue'
        console.log(`%c[${module}] ${message}`, style, meta || '')
      },
      clearLogs: () => set({ logs: [] }),
      exportLogs: () => {
        const { logs } = get()
        return JSON.stringify(logs, null, 2)
      },
    }),
    {
      name: 'wordsmith-logs',
    },
  ),
)

class LoggerService {
  info(module: string, message: string, meta?: any) {
    useLoggerStore.getState().addLog('info', module, message, meta)
  }

  warn(module: string, message: string, meta?: any) {
    useLoggerStore.getState().addLog('warn', module, message, meta)
  }

  error(module: string, message: string, meta?: any) {
    useLoggerStore.getState().addLog('error', module, message, meta)
  }

  action(module: string, message: string, meta?: any) {
    useLoggerStore.getState().addLog('action', module, message, meta)
  }
}

export const logger = new LoggerService()


// --- START OF FILE: src/renderer/services/SettingsService.ts ---
import { AppSettings, useAppStore } from '../store/useAppStore'
import { defaultTemplate } from '../lib/templates/default'

export class SettingsService {
  /**
   * éªŒè¯è®¾ç½®æ˜¯å¦åˆæ³•
   */
  validate(settings: Partial<AppSettings>): { valid: boolean; error?: string } {
    if (settings.ai) {
      if (settings.ai.baseUrl && !settings.ai.baseUrl.startsWith('http')) {
        return { valid: false, error: 'BaseURL å¿…é¡»ä»¥ http æˆ– https å¼€å¤´' }
      }
    }
    
    if (settings.timeout !== undefined) {
      if (settings.timeout < 1000 || settings.timeout > 600000) {
        return { valid: false, error: 'è¶…æ—¶æ—¶é—´å¿…é¡»åœ¨ 1s åˆ° 600s ä¹‹é—´' }
      }
    }

    return { valid: true }
  }

  /**
   * æ¢å¤å‡ºå‚è®¾ç½®
   */
  resetToDefaults() {
    const store = useAppStore.getState()
    
    // 1. é‡ç½®è®¾ç½®
    store.setTheme('system')
    store.updateAi({ baseUrl: 'https://api.openai.com', apiKey: '', model: 'gpt-4o-mini' })
    store.updateTypography({ 
      fontFamily: defaultTemplate.style.fontFamily, 
      fontSizePt: defaultTemplate.style.fontSizePt 
    })
    store.setTemplateId('default')
    
    // 2. é‡ç½®é«˜çº§è®¾ç½® (å¦‚æœæœ‰)
    // store.updateAdvanced(...)
  }

  /**
   * å¯¼å‡ºé…ç½® (è„±æ•)
   */
  exportSettings(): string {
    const settings = useAppStore.getState().settings
    const safeSettings = {
      ...settings,
      ai: {
        ...settings.ai,
        apiKey: settings.ai.apiKey ? '******' : '',
      },
    }
    return JSON.stringify(safeSettings, null, 2)
  }
}

export const settingsService = new SettingsService()


// --- START OF FILE: src/renderer/store/useAppStore.ts ---
import { create } from 'zustand'
import { persist } from 'zustand/middleware'
import type { AIModelConfig, PromptPreset } from '../types/ai'

export type ThemeMode = 'light' | 'dark' | 'system'

/**
 * é»˜è®¤æ’ç‰ˆé…ç½®
 * åŒ…å«å­—ä½“å’Œå­—å·ä¿¡æ¯ï¼Œç”¨äºåˆå§‹åŒ–ç¼–è¾‘å™¨å’Œæ’ç‰ˆå¼•æ“
 */
export interface AIDefaultTypography {
  /** å­—ä½“åç§° (å¦‚ "SimSun", "Microsoft YaHei") */
  fontFamily: string
  /** å­—å· (ä»¥ç£…/ptä¸ºå•ä½) */
  fontSizePt: number
}

export interface HistoryItem {
  id: string
  title: string
  createdAt: number
  mode: 'generate' | 'fix'
  messages: any[]
  finalHtml: string
}

/**
 * åº”ç”¨å…¨å±€è®¾ç½®
 * å­˜å‚¨ç”¨æˆ·åå¥½ã€AIé…ç½®ã€æ’ç‰ˆé»˜è®¤å€¼ç­‰
 */
export interface AppSettings {
  /** ä¸»é¢˜æ¨¡å¼ */
  theme: ThemeMode
  /** AI æ¨¡å‹é…ç½® */
  ai: AIModelConfig
  /** é»˜è®¤æ’ç‰ˆå‚æ•° */
  typography: AIDefaultTypography
  /** å½“å‰é€‰ä¸­çš„æ¨¡æ¿ID */
  templateId: string
  // Advanced Settings
  /** API è¯·æ±‚è¶…æ—¶æ—¶é—´ (æ¯«ç§’) */
  timeout: number
  /** æ˜¯å¦å¼€å¯æŠ¤çœ¼æ¨¡å¼ */
  eyeCareMode: boolean
  /** é»˜è®¤æ–‡ä»¶ä¿å­˜è·¯å¾„ */
  savePath: string
}

/**
 * åº”ç”¨çŠ¶æ€æ¥å£
 * å®šä¹‰äº† Zustand Store çš„ç»“æ„å’Œæ“ä½œæ–¹æ³•
 */
export interface AppState {
  settings: AppSettings
  presets: PromptPreset[]
  history: HistoryItem[]
  
  /** è®¾ç½®ä¸»é¢˜æ¨¡å¼ */
  setTheme: (theme: ThemeMode) => void
  /** æ›´æ–° AI é…ç½® */
  updateAi: (partial: Partial<AIModelConfig>) => void
  /** æ›´æ–°æ’ç‰ˆé»˜è®¤å€¼ */
  updateTypography: (partial: Partial<AIDefaultTypography>) => void
  /** è®¾ç½®å½“å‰æ¨¡æ¿ID */
  setTemplateId: (id: string) => void
  /** æ›´æ–°é€šç”¨è®¾ç½® */
  updateSettings: (partial: Partial<AppSettings>) => void // Generic updater
  
  /** æ·»åŠ æ–°çš„æç¤ºè¯é¢„è®¾ */
  addPreset: (preset: Omit<PromptPreset, 'id'>) => void
  /** æ›´æ–°ç°æœ‰çš„æç¤ºè¯é¢„è®¾ */
  updatePreset: (id: string, partial: Partial<Omit<PromptPreset, 'id'>>) => void
  /** åˆ é™¤æç¤ºè¯é¢„è®¾ */
  removePreset: (id: string) => void
  
  /** æ·»åŠ å†å²è®°å½• */
  addHistoryItem: (item: Omit<HistoryItem, 'id' | 'createdAt'>) => void
  /** åˆ é™¤å•æ¡å†å²è®°å½• */
  deleteHistoryItem: (id: string) => void
  /** æ¸…ç©ºæ‰€æœ‰å†å²è®°å½• */
  clearHistory: () => void
}

function uid(prefix: string): string {
  return `${prefix}_${Math.random().toString(16).slice(2)}_${Date.now().toString(16)}`
}

/**
 * åˆ›å»ºåº”ç”¨å…¨å±€ Store
 * ä½¿ç”¨ persist ä¸­é—´ä»¶å®ç°æ•°æ®æŒä¹…åŒ– (localStorage)
 */
export const useAppStore = create<AppState>()(
  persist(
    (set) => ({
      settings: {
        theme: 'system',
        ai: { baseUrl: 'https://api.openai.com', apiKey: '', model: 'gpt-4o-mini' },
        typography: { fontFamily: 'SimSun', fontSizePt: 12 },
        templateId: 'default',
        timeout: 60000,
        eyeCareMode: false,
        savePath: 'My Documents/WordSmith',
      },
      presets: [
        {
          id: uid('preset'),
          name: 'é»˜è®¤ï¼ˆä¸¥æ ¼åè®®ï¼‰',
          mode: 'generate',
          userPrompt: 'ä¸¥æ ¼éµå¾ªæ’ç‰ˆåè®®è¾“å‡º HTMLï¼Œæ®µè½å±‚æ¬¡æ¸…æ™°ï¼Œè¡¨æ ¼å±…ä¸­ï¼Œå¿…è¦æ—¶ä½¿ç”¨ 12ptã€‚',
        },
      ],
      history: [],

      setTheme: (theme) => set((s) => ({ settings: { ...s.settings, theme } })),
      updateAi: (partial) => set((s) => ({ settings: { ...s.settings, ai: { ...s.settings.ai, ...partial } } })),
      updateTypography: (partial) =>
        set((s) => ({ settings: { ...s.settings, typography: { ...s.settings.typography, ...partial } } })),
      setTemplateId: (id) => set((s) => ({ settings: { ...s.settings, templateId: id } })),
      updateSettings: (partial) => set((s) => ({ settings: { ...s.settings, ...partial } })),

      addPreset: (preset) => set((s) => ({ presets: [{ ...preset, id: uid('preset') }, ...s.presets] })),
      updatePreset: (id, partial) =>
        set((s) => ({
          presets: s.presets.map((p) => (p.id === id ? { ...p, ...partial } : p)),
        })),
      removePreset: (id) => set((s) => ({ presets: s.presets.filter((p) => p.id !== id) })),

      addHistoryItem: (item) =>
        set((s) => ({
          history: [
            { ...item, id: uid('history'), createdAt: Date.now() },
            ...s.history,
          ].slice(0, 50), // Limit history size
        })),
      deleteHistoryItem: (id) => set((s) => ({ history: s.history.filter((item) => item.id !== id) })),
      clearHistory: () => set({ history: [] }),
    }),
    {
      name: 'wordsmith-storage',
    },
  ),
)

export function getSelectedPreset(): PromptPreset | null {
  const state = useAppStore.getState()
  return state.presets[0] ?? null
}


// --- START OF FILE: src/renderer/store/useI18nStore.ts ---
import { create } from 'zustand'
import { persist } from 'zustand/middleware'
import { zhCN, type LocaleResource } from '../locales/zh-CN'
import { enUS } from '../locales/en-US'

export type LocaleType = 'zh-CN' | 'en-US'

interface I18nState {
  locale: LocaleType
  t: LocaleResource
  setLocale: (locale: LocaleType) => void
}

const resources: Record<LocaleType, LocaleResource> = {
  'zh-CN': zhCN,
  'en-US': enUS,
}

export const useI18nStore = create<I18nState>()(
  persist(
    (set) => ({
      locale: 'zh-CN',
      t: zhCN,
      setLocale: (locale) => set({ locale, t: resources[locale] }),
    }),
    {
      name: 'wordsmith-i18n',
      partialize: (state) => ({ locale: state.locale }),
      onRehydrateStorage: () => (state) => {
        if (state) {
          state.t = resources[state.locale]
        }
      },
    },
  ),
)

// Hook helper for cleaner usage
export const useI18n = () => useI18nStore((s) => s.t)
export const useLocale = () => useI18nStore((s) => s.locale)
export const useSetLocale = () => useI18nStore((s) => s.setLocale)


// --- START OF FILE: src/renderer/store/useToastStore.ts ---
import { create } from 'zustand'

export type ToastVariant = 'default' | 'destructive' | 'success' | 'warning' | 'info'

export interface Toast {
  id: string
  title?: string
  description?: string
  variant?: ToastVariant
  duration?: number
  createdAt: number
}

interface ToastState {
  toasts: Toast[]
  addToast: (toast: Omit<Toast, 'id' | 'createdAt'>) => void
  dismissToast: (id: string) => void
}

export const useToastStore = create<ToastState>((set) => ({
  toasts: [],
  addToast: (toast) => {
    const id = Math.random().toString(36).substring(2, 9)
    const newToast = { ...toast, id, createdAt: Date.now() }
    
    set((state) => ({ 
      // Limit to max 5 toasts to avoid clutter
      toasts: [...state.toasts, newToast].slice(-5) 
    }))

    if (toast.duration !== Infinity) {
      setTimeout(() => {
        set((state) => ({
          toasts: state.toasts.filter((t) => t.id !== id),
        }))
      }, toast.duration || 5000)
    }
  },
  dismissToast: (id) =>
    set((state) => ({
      toasts: state.toasts.filter((t) => t.id !== id),
    })),
}))

export const toast = (props: Omit<Toast, 'id' | 'createdAt'>) => {
  useToastStore.getState().addToast(props)
}


// --- START OF FILE: src/renderer/types/ai.ts ---
export type ChatRole = 'system' | 'user' | 'assistant'

export interface ChatMessage {
  role: ChatRole
  content: string
}

export type PromptMode = 'generate' | 'fix'

export interface AIDefaultTypography {
  fontFamily: string
  fontSizePt: number
}

export interface AIModelConfig {
  baseUrl: string
  apiKey: string
  model: string
}

export interface StreamChatRequest {
  mode: PromptMode
  model: AIModelConfig
  defaults: AIDefaultTypography
  messages: ChatMessage[]
  signal?: AbortSignal
}



// --- START OF FILE: src/renderer/types/guard.ts ---
export interface GuardReport {
  removedStyleTags: number
  removedStylesheetLinks: number
  convertedUnits: number
  enforcedBodyStyle: boolean
  tablesProcessed: number
  mathMlNodesRemoved: number
}

export interface GuardResult {
  html: string
  report: GuardReport
}



// --- START OF FILE: src/renderer/types/prismjs-components.d.ts ---
declare module 'prismjs/components/*'



// --- START OF FILE: src/renderer/vite-env.d.ts ---
/// <reference types="vite/client" />


